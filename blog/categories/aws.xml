<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <title><![CDATA[Tech.Semicolon]]></title>
    <link href="https://techsemicolon.github.io/blog/categories/aws.xml" rel="self"/>
    <link href="https://techsemicolon.github.io/"/>
    <updated>2020-02-05T12:38:41+00:00</updated>
    <id>https://techsemicolon.github.io/</id>
        <generator uri="http://sculpin.io/">Sculpin</generator>
            <entry>
            <title type="html"><![CDATA[Stream Nginx and PHP FPM logs into AWS cloudwatch]]></title>
            <link href="https://techsemicolon.github.io/blog/2020/02/04/stream-nginx-fpm-logs-into-aws-clodwatch/"/>
            <updated>2020-02-04T00:00:00+00:00</updated>
            <id>https://techsemicolon.github.io/blog/2020/02/04/stream-nginx-fpm-logs-into-aws-clodwatch/</id>
            <content type="html"><![CDATA[<p>When you have a web application running on AWS instances, you may have control over some cloud monitors of the instances such as <code>Memory Usage</code>, <code>CPU Utilization</code> or even metrics related to storage space. But :</p>

<ul>
<li>What if you want to have your nginx and PHP FPM logs steamed on AWS?</li>
<li>You want to set up a cloudwatch alarm if nginx throws an error?</li>
<li>You have an autoscaling setup and you want to steam nginx logs of all servers at a central log group on cloudwatch?</li>
<li>You do not want to incorporate any 3rd party monitoring tool and want to stick to AWS?</li>
<li>Last but not the least, you want it to be cost effective as logs are going to pile up as time goes?</li>
</ul>

<p>Well, this is all possible now! Let's find out how...</p>

<h4 id="aws-cloudwatch-agent-%3A">AWS Cloudwatch Agent :</h4>

<p>The first and very basic question comes to mind when streaming any custom log file into AWS cloudwatch is : <code>How I am going to stream the logs continously to AWS cloudwatch</code> The answer is using <a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/Install-CloudWatch-Agent.html"><code>AWS Cloudwatch Agent</code></a></p>

<p>On a broader level, once you install AWS Cloudwatch Agent on your EC2 instance, it's going to have a service called <code>awslogs</code> available for you. This service is responsible for streaming any log file you wish to track on AWS cloudwatch. This service will take care of how to push the logs, how much log buffer to push at a time, how much kbs of data to push at a time and so on.</p>

<p>As any unix service would have, the <code>awslogs</code> service also has very handy configuration file using which you can tweak the above parameters which contribute to pushing the log stream into AWS cloudwatch.</p>

<h3 id="giving-permissions-to-push-to-cloudwatch-%3A">Giving permissions to push to cloudwatch :</h3>

<p>When we have the AWS Cloudwatch agent installed and the <code>awslogs</code> service running, you will expect the log streaming on AWS cloudwatch inside AWS region you specified. But, it will not work directly.</p>

<p>This is because, the instance should have permission to push logs into cloudwatch. For this we will create a new policy called <code>AWS-cloudwatch-agent-policy</code>.</p>

<ol>
<li>Login to AWS Console and go to <code>IAM</code> service.</li>
<li>Go to <code>Policies</code> from the L.H.S. menu</li>
<li>Click on <code>Create Policy</code></li>
<li>A visual editor for policy will be shown. But we are going to save time here. Click on the <code>json</code> tab and enter following json in there :</li>
</ol>

<pre><code class="json">{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:PutLogEvents",
                "logs:DescribeLogStreams"
            ],
            "Resource": [
                "arn:aws:logs:*:*:*"
            ],
            "Condition": {
                "StringEquals": {
                    "aws:RequestedRegion": "xx-xxxx-x"
                }
            }
        }
    ]
}
</code></pre>

<p>Make sure you replace <code>xx-xxxx-x</code> with the region you want to steam logs into. e.g. <code>us-west-1</code>
5. Click on <code>Review Policy</code>
6. Give <code>Name</code> as <code>AWS-cloudwatch-agent-policy</code>. If you want to be specific(which I would recommend), add the region name in there e.g. <code>AWS-cloudwatch-agent-policy-us-west-1</code>
7. Give <code>Description</code> and click on <code>Create Policy</code></p>

<p>Now, we have the policy ready. We need to attach this policy to an <code>IAM User</code> or <code>IAM Role</code> so that EC2 instance can stream logs into AWS cloudwatch. There are 2 ways to do it :</p>

<p>A. If your EC2 instance is having an instance IAM role attached to it, then simply attach this policy to that role. You can find this by going into <code>EC2 instances</code> section and looking for instance property called <code>IAM Role</code>.</p>

<p>OR</p>

<p>B. If you do not have any IAM role attached to your instance, then create a new IAM user with name <code>AWS-cloudwatch-agent-user</code> with ONLY <code>programatic access</code> enabled. Then attach the policy we created above to this user. Make sure you save the <code>Access Keys</code> and <code>Secret Access Keys</code> for this user. We will need it shortly.</p>

<h4 id="installing-the-agent-%3A">Installing the agent :</h4>

<p>Now that we have the permissions sorted out, let's install AWS cloudwatch agent, which is the easiest task to do. I am using an <code>ubuntu</code> EC2 instance so I will follow the steps relevent to it in this article. If you are using any other operating systems, feel free to visit the <a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/install-CloudWatch-Agent-on-EC2-Instance.html">installation documentation</a></p>

<ol>
<li>SSH into your ubuntu EC2 instance</li>
<li>Run following commands :</li>
</ol>

<pre><code class="bash"># Switch to root user
sudo -s
# Update the packages
apt-get update -y
# Download the ubuntu cloudwatch agent setup file
cd /root
curl https://s3.amazonaws.com/aws-cloudwatch/downloads/latest/awslogs-agent-setup.py -O
# Install the cloudwatch agent
# Make sure you replace xx-xxxx-x with your region e.g. us-west-1
sudo python ./awslogs-agent-setup.py --region=xx-xxxx-x
</code></pre>

<ol start="3">
<li>Once you run the <code>awslogs-agent-setup.py</code>, it will ask you couple of questions in the prompt like below :</li>
</ol>

<p>When it will ask for <code>AWS Access Key ID</code> &amp; <code>AWS Secret Access Key</code>, if you have chosen the option A in previous section which is using <code>IAM Role</code> of the instance, then press continue(enter) without anything. If you have chosen the option B which is using an <code>IAM User</code> with programatic access, add the <code>AWS Access Key ID</code> &amp; <code>AWS Secret Access Key</code> of that user and then proceed with the prompt.</p>

<p>On the remaining prompt, just follow what we have below. We will just start with basic bare bones because, we are going to update these settings from config file in next step.</p>

<pre><code class="bash">Step 1 of 5: Installing pip ...libyaml-dev does not exist in system DONE

Step 2 of 5: Downloading the latest CloudWatch Logs agent bits ... DONE

Step 3 of 5: Configuring AWS CLI ...
AWS Access Key ID [None]:
AWS Secret Access Key [None]:
Default region name [us-west-1]:
Default output format [None]:

Step 4 of 5: Configuring the CloudWatch Logs Agent ...
Path of log file to upload [/var/log/syslog]:
Destination Log Group name [/var/log/syslog]:

Choose Log Stream name:
  1. Use EC2 instance id.
  2. Use hostname.
  3. Custom.
Enter choice [1]: 1

Choose Log Event timestamp format:
  1. %b %d %H:%M:%S    (Dec 31 23:59:59)
  2. %d/%b/%Y:%H:%M:%S (10/Oct/2000:13:55:36)
  3. %Y-%m-%d %H:%M:%S (2008-09-08 11:52:54)
  4. Custom
Enter choice [1]: 3

Choose initial position of upload:
  1. From start of file.
  2. From end of file.
Enter choice [1]: 2
More log files to configure? [Y]: N

Step 5 of 5: Setting up agent as a daemon ...DONE


------------------------------------------------------
- Configuration file successfully saved at: /var/awslogs/etc/awslogs.conf
- You can begin accessing new log events after a few moments at https://console.aws.amazon.com/cloudwatch/home?region=us-west-1#logs:
- You can use 'sudo service awslogs start|stop|status|restart' to control the daemon.
- To see diagnostic information for the CloudWatch Logs Agent, see /var/log/awslogs.log
- You can rerun interactive setup using 'sudo python ./awslogs-agent-setup.py --region us-west-1 --only-generate-config'
</code></pre>

<h3 id="testing-the-initial-setup-%3A">Testing the initial setup :</h3>

<p>Let's first check if the <code>awslogs</code> service is running :</p>

<pre><code class="bash">sudo service awslogs status
</code></pre>

<p>This should show as active.</p>

<p>Now let's see if our instance is streaming anything :</p>

<pre><code class="bash">sudo tail -f /var/log/awslogs.log
</code></pre>

<p>You should either see something like <code>cwlogs.push.publisher</code> which is publishing log successfully. If you have any issue with permissions, you should see the error here.</p>

<p>If everything is working, you should see a log group called <code>/var/log/syslog</code> when you visit https://console.aws.amazon.com/cloudwatch/home?region=xx-xxxx-x#logs: where <code>xx-xxxx-x</code> is your AWS region. If you click on the log group, you should see syslogs streaming in there. whohooo!</p>

<p><img src="/images/aws-cloudwatch-agent/log-group.png" alt="AWS CloudWatch Log Group" /></p>

<p><img src="/images/aws-cloudwatch-agent/log-stream.png" alt="AWS CloudWatch Log Stream" /></p>

<h3 id="updating-the-configurations-%3A">Updating the configurations :</h3>

<p>Let's first stop the <code>awslogs</code> service for a moment to avoid any syslogs steaming into AWS cloudwatch.</p>

<pre><code class="bash">sudo service awslogs stop
</code></pre>

<p>Now, we are going to update the configuration file <code>/var/awslogs/etc/awslogs.conf</code>. Edit this file and add below contents in it :</p>

<pre><code>[general]
state_file = /var/awslogs/state/agent-state

[nginx]
file = /var/log/nginx/error.log
log_group_name = nginx_error_logs
log_stream_name = {instance_id}-{hostname}
datetime_format = %b %d %H:%M:%S
initial_position = end_of_file

[phpfpm]
file = /var/log/php7.2-fpm.log
log_group_name = php_fpm_logs
log_stream_name = {instance_id}-{hostname}
datetime_format = %b %d %H:%M:%S
initial_position = end_of_file
</code></pre>

<p>Note : Make sure you verify the log file paths as per your server settings.</p>

<p>Let's quickly go over what we have set. The <code>general</code> section is what this service needs to keep its state intact. We have kept it as it is.</p>

<p>The next 2 sections <code>nginx</code> and <code>phpfpm</code> will stream the logs. 
1. <code>file</code> : The absolute path of the respective log file
2. <code>log_group_name</code> : Log group which will cloud all similar logs together in AWS cloudwatch
3. <code>log_stream_name</code> : The name of the stream of this log group pushed from an instance
4. <code>datetime_format</code> : The format of logged timestemp
5. <code>initial_position</code> : If you would like to stream the new lines from end of the time or from begining of the file(start_of_file)</p>

<p>If you wish to know more about these options, visit this <a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/AgentReference.html">documentation</a></p>

<p>Once you save this file, start the <code>awslogs</code> service :</p>

<pre><code class="bash">sudo service awslogs start
</code></pre>

<p>Finally, you will now see nginx and phpfpm logs steaming into your AWS cloudwtch logs in their respective log groups.</p>

<h4 id="avoiding-streaming-of-notices-and-warnings-%3A">Avoiding streaming of notices and warnings :</h4>

<p>At this point in your setup, the <code>awslogs</code> service will stream every log entry from the files you are streaming, no matter if it's an <code>info</code>, <code>notice</code>, <code>warning</code> or an <code>error</code>.</p>

<p>You would not want to pile up your AWS cloudwatch logs with anything which you do not want to track. You can get around this from choosing either of below options :</p>

<p>A. Updating nginx and php fpm service configurations and making sure their log levels are set just to log <code>errors</code> or <code>warnings</code> if you want.
B. You can use the <code>awslogs</code> configuration option called <code>multi_line_start_pattern</code> where you can specify a regex which will determine the start of the line.</p>

<h4 id="setting-up-a-cloudwatch-alarm-%3A">Setting up a cloudwatch alarm :</h4>

<p>Now that we have the nginx and phpfpm logs into AWS cloudwatch, it's time to do the main step. Let's set up an alarm.</p>

<ol>
<li>Login to AWS Console and go to <code>Cloudwatch</code> service.</li>
<li>Go to <code>Alarms &gt; Alarm</code> from the L.H.S. menu</li>
<li>Click on <code>Create Alarm</code></li>
<li>Click on <code>Select Metric</code> and search for <code>Log Group</code>, you will see <code>Logs &gt; Log Group Metrics</code>, select that</li>
<li>From <code>LogGroupName</code>, select the log group you want to monitor. You should see <code>nginx_error_logs</code> and <code>php_fpm_logs</code> in the listing, choose any one of them</li>
<li>You will see the screen where we specify the alarm conditions. You can set duration of 5 minutes for a static threshold when incoming logs are greater than 50. This means that if for a period of 5 minutes, if any of the log group we select have more than 50 logs, this alarm will go on.</li>
</ol>

<p><img src="/images/aws-cloudwatch-agent/log-alarm.png" alt="AWS CloudWatch Log Alarm" /></p>

<h4 id="pricing-%3A">Pricing :</h4>

<p>The AWS cloudwatch agent is free because it's a native service running on your instance. However, what you pay is for the amount of logs you collect, stream and store over AWS cloudwatch. You can check the pricing from their <a href="https://aws.amazon.com/cloudwatch/pricing/">documentation</a>. However, you will find it's much cheaper than most of the 3rd party services providing similar log monitoring service.</p>

<h4 id="final-words-%3A">Final words :</h4>

<p>It's said that you can spread over different cloud providers or service providers to explore more. But in my experience, AWS has these native options which are cost effective, easy and standard to set up.. Plus you have everything in one console, you should definitely give it a try before shifting to a 3rd party solution implementing the same thing.</p>
]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[New AWS EC2 instance connect can save you instance ssh headaches]]></title>
            <link href="https://techsemicolon.github.io/blog/2019/10/20/now-aws-ec2-aws-instance-connect-can-save-you-instance-user-ssh-headaches/"/>
            <updated>2019-10-20T00:00:00+00:00</updated>
            <id>https://techsemicolon.github.io/blog/2019/10/20/now-aws-ec2-aws-instance-connect-can-save-you-instance-user-ssh-headaches/</id>
            <content type="html"><![CDATA[<p>AWS EC2 is one of the most commonly used service for hosting instances on AWS cloud. When you have multiple team members, you have to handle headaches of managing their SSH acces. Well... What if I tell you that now :</p>

<ul>
<li>You can manage EC2 ssh access by adding just AWS IAM user policy. Oh yes! You read that right!</li>
<li>NO need to add SSH keys and manage those on your own for providing access to users in the organization</li>
<li>NO need to release production instance updates to add or remove new users and their SSH keys</li>
<li>NO need to worry about the key rotation, key management done by AWS automatically</li>
<li>All connection requests using EC2 Instance Connect are logged to AWS CloudTrail so that you can audit connection requests</li>
<li>Optionally, If your instance is publically accessible, you can SSH directly from an AWS browser shell window without even doing SSH locally</li>
<li>Last but not the least, you can set this up entirely on an instance under just 15 minutes</li>
</ul>

<p>This is all possible now, thanks to the new AWS service called <code>EC2 instance connect</code>. If this does not convince you to explore more about this, nothing else will!</p>

<h4 id="aws-instance-connect-%3A">AWS Instance Connect :</h4>

<p>This is by far one of my favorite AWS service announcement of 2019. We all have had our headaches to manage SSH keys on EC2 instances, add new keys for new users, rotate the keys to add more security, remove the keys for users who left the company. Oh man, give me more tissues!</p>

<p>But the new <code>AWS EC2 connect</code> is the ultimate saviour.</p>

<p><code>AWS EC2 Instance Connect</code> provides a simple and secure way to connect to your instances using <code>Secure Shell (SSH)</code>. With EC2 Instance Connect, you use <code>AWS Identity and Access Management</code> (IAM) policies and principals to control SSH access to your instances, removing the need to share and manage SSH keys. All connection requests using EC2 Instance Connect are logged to <code>AWS CloudTrail</code> so that you can audit connection requests.</p>

<p>You can use Instance Connect to connect to your Linux instances using one or all of below :</p>

<ul>
<li>A browser-based client</li>
<li>The Amazon EC2 Instance Connect CLI</li>
<li>The SSH client of your choice.</li>
</ul>

<p>The cheery on the top is <code>temporary nature of the SSH public key</code>. When you connect to an instance using EC2 Instance Connect, the instance connect API pushes a <code>one time use SSH public key</code> to the instance which is getting connected. It uses instance metadata for the same. And it key just stays there for <code>60 seconds</code>, so that SSH is done correctly. That key is then removed and for next connection the same process is done internally by AWS EC2 instance connect.</p>

<p>An IAM policy attached to your IAM user authorizes your IAM user to push the public key to the instance metadata and for the users who do not have this policy attached, they can not connect to the instance.</p>

<p>The SSH daemon internally uses AuthorizedKeysCommand and AuthorizedKeysCommandUser, which are configured when Instance Connect is installed, to look up the public key from the instance metadata for authentication, and connects you to the instance.</p>

<p>Isn't that awesome!</p>

<h3 id="a-heads-up-on-instance-os-support-%3A">A heads up on instance OS support :</h3>

<p>The EC2 instance connect is currently supported for :</p>

<ul>
<li>Amazon Linux 2 having any version</li>
<li>Ubuntu 16.04 or later versions</li>
</ul>

<p>Hoping that AWS will add support for the other operating systems!</p>

<h3 id="step-1---spinning-up-the-ec2-server-to-dryrun-ecv2-instance-connect-%3A">Step 1 - Spinning up the EC2 server to dryrun ECV2 Instance Connect :</h3>

<p>I would highly recommend to NOT try installing anything on your working instance. It is always safe to try it out on a small vanilla instance, know the gotchas and then be prepared to do it on production or any of your existing instances. So for the dryrun we will spin up a test EC2 instance.</p>

<ul>
<li>Login to your AWS Console and go to the region you want the instance to be in</li>
<li>Select EC2 service and click on <code>Launch</code> to spin up a new instance</li>
<li>The EC2 launch wizard will be shown, search for <code>ubuntu</code> and press <code>enter</code></li>
<li>It will show number of ubuntu AMIs. Let's choose <code>Ubuntu Server 18.04 LTS</code></li>
<li>Now click on <code>select</code></li>
<li>Click on <code>continue</code> and choose instance type as <code>t2.micro</code> as it is inside the <code>free tier</code> usage</li>
<li>Click on <code>Next: Configure Instance Details</code></li>
<li>In this step you dont need to worry about VPC and instance role as this instance is just a test one. You can keep the default settings</li>
<li>Click on <code>Next: Add Storage</code></li>
<li>Keep the default storage as it is as we won't need any extra storage space</li>
<li>Click on <code>Next: Add Tags</code> and add the tags you need for this instance</li>
<li>Click on <code>Next: Configure Security Group</code></li>
<li>You need to select <code>Create a new security group</code>. Add security group name as <code>Temporary EC2 Connect SG</code>. And add just a rule for port 22(SSH) open to all with value <code>0.0.0.0/0</code></li>
<li>Click on <code>Review and Launch</code></li>
<li>Verify the details once in this final summary screen and click on <code>Launch</code></li>
<li>It will ask you to select a <code>key pair</code> create a new one as <code>EC2-Connect-Dryrun-key-pair</code> and download it.</li>
<li>Now finally.. Click on <code>Launch Instances</code></li>
</ul>

<p>You are done with launching the instance..</p>

<h4 id="step-2-%3A-install-ec2-instance-connect-on-the-instance-%3A">Step 2 : Install EC2 Instance Connect on the instance :</h4>

<p>Now, we will install EC2 instance connect service on our new EC2 instance with AWS CLI. You can SSH to your instance using following command :</p>

<pre><code class="bash">ssh -i EC2-Connect-Dryrun-key-pair.pem ubuntu@x.x.x.x
</code></pre>

<p>Where x.x.x.x is the new instance IP address. Now you can use below set of commands to install AWS CLI and then EC2 instance connect :</p>

<pre><code class="bash"># Update the packages as we are logging to the instance for the first time
sudo apt-get -y update
# Install python 3 and pip3 which is needed to install AWS CLI
sudo add-apt-repository ppa:ubuntu-toolchain-r/ppa
sudo apt install -y python3.7 python3-pip
# Install AWS CLI
sudo pip3 install awscli --upgrade --user
# Install EC2 instance connect
sudo apt-get install -y ec2-instance-connect
# Make sure instance connect files are created properly
ls -1  /usr/share/ec2-instance-connect/
</code></pre>

<p>You can verify the instance connect has updated the ssh setting by running follwing command :</p>

<pre><code class="bash">sudo cat /lib/systemd/system/ssh.service.d/ec2-instance-connect.conf
</code></pre>

<p>This should give output containing following strings :</p>

<pre><code class="bash">AuthorizedKeysCommand /usr/share/ec2-instance-connect/eic_run_authorized_keys %u %f
AuthorizedKeysCommandUser ec2-instance-connect
</code></pre>

<p>Now, you are done with the setup on your instance. Believe it or not, that is it for the instance changes!</p>

<h4 id="step-3-%3A-create-policy-to-allow-ssh-connect-access-%3A">Step 3 : Create policy to allow SSH Connect Access :</h4>

<p>We will create a new <code>IAM policy</code> which we can attach to a user so that user can SSH to the instance. Below is the policy JSON :</p>

<pre><code class="json">{
    "Version": "2012-10-17",
    "Statement": [
      {
        "Effect": "Allow",
        "Action": "ec2-instance-connect:SendSSHPublicKey",
        "Resource": [
            "arn:aws:ec2:region:account-id:instance/i-1234567890abcdef0",
            "arn:aws:ec2:region:account-id:instance/i-0598c7d356eba48d7"
        ],
        "Condition": {
            "StringEquals": {
                "ec2:osuser": "ubuntu"
            }
        }
      },
      {
        "Effect": "Allow",
        "Action": "ec2:DescribeInstances",
        "Resource": "*"
      }
    ]
}
</code></pre>

<p>Make sure you replace the resources with their respective arns. e.g. <code>arn:aws:ec2:us-west-1:12341274:instance/i-1234567890abcdef0</code> where region is <code>us-west-1</code> and account id is <code>12341274</code>.</p>

<p>Let's now understand this policy. This policy will allow user to send a new SSH public key to the instances specified in the resources array. This pushed public key will allow the SSH connection to the instance.</p>

<p>The <code>ec2:osuser</code> as <code>ubuntu</code> is the SSH connection linux user. Realistically <code>ubuntu</code> is the main super user. We will change this on the last part of this article where we can have different linux user having less priviledges on the instance. For now, let's keep going.</p>

<p>The second policy rule <code>ec2:DescribeInstances</code> is used by the user to get instance details from its instance id. We will be using instance id instead of public or private DNS or IP. So this rule is required in the policy so that part of the process works.</p>

<ul>
<li>Login to your AWS Console</li>
<li>Select IAM service and click on <code>Policies</code> tab on the left menu</li>
<li>Click on <code>Create Policy</code></li>
<li>Click on <code>JSON</code> tab and enter above policy JSON in it. Make sure you replace the instance ARN as per your instance metadata details</li>
<li>Click on <code>Review Policy</code></li>
<li>Give policy name as <code>EC2-SSH-Access</code> and enter description you need</li>
<li>Click on <code>Create</code></li>
</ul>

<p>Now we have the policy ready which can give access to any user to connect to the instance via Secure Shell (SSH).</p>

<h4 id="step-4-%3A-create-a-new-user-and-attach-policy-%3A">Step 4 : Create a new User and attach policy :</h4>

<p>We will create a new user as <code>user-with-ssh-access</code> and attach above policy.</p>

<ul>
<li>Login to your AWS Console</li>
<li>Select IAM service and click on <code>Users</code> tab on the left menu</li>
<li>Click on <code>Add User</code></li>
<li>Give user name as <code>user-with-ssh-access</code></li>
<li>In <code>Select AWS access type</code> choose <code>Programmatic access</code></li>
<li>Click on <code>Next: Permissions</code></li>
<li>In set permiossions tab choose <code>Attach existing policies directly</code></li>
<li>Search our policy <code>EC2-SSH-Access</code> and select it</li>
<li>Click on <code>Next: Tags</code> and add tags as per your need</li>
<li>Click on <code>Next</code> which will review your user</li>
<li>Click on <code>Create</code></li>
</ul>

<p>Now, we will need to add AWS credentials to this user so that we can use those to connect.</p>

<ul>
<li>Login to your AWS Console</li>
<li>Select IAM service and click on <code>Users</code> tab on the left menu</li>
<li>Search our user <code>user-with-ssh-access</code> and click on it</li>
<li>User <code>Summary</code> page will appear, click on <code>Security credentials</code> tab</li>
<li>In <code>Access Keys</code> section click on <code>Create access key</code></li>
<li>It will give you <code>Access Key Id</code> and <code>Secret Access Key</code>. Make sure you save it locally in notepad or somewhere safe as we will need it to ssh to the instance</li>
</ul>

<h4 id="step-5-%3A-setting-up-local-system-for-secure-shellssh-connection-%3A">Step 5 : Setting up local system for Secure Shell(SSH) connection :</h4>

<p>Locally you need to have AWS CLI installed. If you do not have it, make sure you install it. <a href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-install.html">Click Here</a> to folow the steps.</p>

<p>Once install run following on your terminal :</p>

<pre><code class="bash">aws configure
</code></pre>

<p>If you get error like <code>aws command not found</code> find where the aws service is installed on your computer by doing <code>which aws</code>. Sometimes you need to add full path like <code>/usr/local/bin/aws configure</code></p>

<p>It will ask you details like below :</p>

<pre><code class="bash">AWS Access Key ID : ********************
AWS Secret Access Key : ****************************
Default region name [None]: us-west-1
Default output format [None]:
</code></pre>

<p>Make sure you add the access key and secret access key we got from earlier step and specify the region in which your EC2 instance resides.</p>

<p>Now, you need to also install <code>EC2 Instance Connect</code> on your local system as it is used to ssh to the instance. Use following command to do the same :</p>

<pre><code class="bash">sudo pip install ec2instanceconnectcli
</code></pre>

<p>And done! Your local system is ready to SSH connect!</p>

<h4 id="step-5-%3A-connect-to-the-instance-via-secure-shellssh-%3A">Step 5 : Connect to the instance via Secure Shell(SSH) :</h4>

<p>After all above steps are done, we can now SSH to our instance. To ssh we will use <code>mssh</code> command which ships with EC2 instance connect service.</p>

<pre><code class="bash">mssh ubuntu@i-xxxxxxxxxxxxxxx
</code></pre>

<p>Where <code>i-xxxxxxxxxxxxxxx</code> is the instance id of our test instance we spun up in step 1. You would be able to SSH to the instance if you have followed above steps correctly.</p>

<h4 id="real-world-use-cases-for-ssh-users-%3A">Real world use cases for SSH users :</h4>

<p>In above setup, we used <code>ubuntu</code> user to SSH connect. However, in real world we can divide our organizational users who need access into groups based on access they need. For example :</p>

<ul>
<li>You can create a user named <code>administrator</code> on your EC2 instance and then use that as <code>ec2:osuser</code> in our policy for system administrators.</li>
<li>You can create a user named <code>developer</code> on your EC2 instance and then use that as <code>ec2:osuser</code> in our policy for application team which might have access to just the application codebase.</li>
</ul>

<p>Please note that what access and permission the connected user must have is in your hands. The responsibility of EC2 instance connect is just to allow the IAM user to SSH to the instance with allowed SSH user.</p>

<p><a href="https://aws.amazon.com/premiumsupport/knowledge-center/new-user-accounts-linux-instance/">Click Here</a> to know more about quick steps to add new user to the instance.</p>

<h4 id="managing-the-ssh-access-%3A">Managing the ssh access :</h4>

<p>You can create multiple policies based on the resources and os username the IAM user can SSH to. If you want to give a new user ssh access, you can just attach respective policy to the user. Similarly, you can just remove an existing ssh cononect policy to remove the SSH access from an existing user.</p>

<p>This is a HUGEEEE plus point of this service.</p>

<h4 id="accessing-the-connection-logs-%3A">Accessing the connection logs :</h4>

<p>EC2 connect pushes the SSH connection logs to <code>AWS Cloudtrail</code>. To view the logs follow below steps :</p>

<ul>
<li>Login to your AWS Console</li>
<li>Select Clourtrail service and go to the region you have EC2 instance connect resources in</li>
<li>Click on <code>Event History</code> tab on the left menu</li>
<li>Addd <code>Event source</code> as the filter type and enter <code>ec2-instance-connect.amazonaws.com</code> as it's value</li>
</ul>

<p>You would be able to see all the SSH conection logs. Beautiful fact is that, even if you have 10 different IAM users using same SSH user, let's say <code>developer</code>, in the logs, you would be able to differentiate which user connected to SSH via <code>developer</code> connection user.</p>
]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[A complete setup guide for OpenVPN on AWS with free CertBot SSL]]></title>
            <link href="https://techsemicolon.github.io/blog/2019/10/19/complete-setup-guide-for-openvpn-on-aws-with-certbot-ssl/"/>
            <updated>2019-10-19T00:00:00+00:00</updated>
            <id>https://techsemicolon.github.io/blog/2019/10/19/complete-setup-guide-for-openvpn-on-aws-with-certbot-ssl/</id>
            <content type="html"><![CDATA[<p>OpenVPN is a commercial VPN solutions service to secure your data communications. You can use this in number of ways like hiding your internet identity, remote access to company, inside IoT security and many more. My most favorite use of OpenVPN is to use it as SSH whitelisting, so you can SSH to your server instances only when you are connected to a certain VPN.</p>

<p>Remember, OpenVPN service is not free, but it's cost is very affordable and reasonable for a personal as well as corporate setup!</p>

<h3 id="overview-of-aws-setup-%3A">Overview of AWS setup :</h3>

<p>When you spin up an EC2 instance on AWS, you can either choose from vanilla instance AMIs like basic centos or ubuntu 16.x etc. OR you can choose from pre-baked marketplace AMIs. Services like OpenVPN use marketplace AMIs to provide their pre-baked instances which are ready to use.</p>

<p>But wait.. It is not that plug and play. Setting up OpenVPN can be tricky specially when you do not know the sequence of steps and some little tricks. But, we have got you covered.</p>

<p>We will be also dealing with the common problem of untrusted SSL certificate error and install a free CertBot SSL to make your OpenVPN server full proof. Let's get started!</p>

<h3 id="step-1---spinning-up-the-ec2-server-%3A">Step 1 - Spinning up the EC2 server :</h3>

<ul>
<li>Login to your AWS Console and go to the region you want yout OpenVPN instance to be in</li>
<li>Select EC2 service and click on <code>Launch</code> to spin up a new instance</li>
<li>The EC2 launch wizard will be shown, where click on <code>AWS Marketplace</code> on left</li>
<li>Now search for <code>openvpn</code> and press <code>enter</code></li>
<li>It will show number of official OpenVPN marketplace AMIs which are different in the number of connected devices. I will strongly recommend if you are doing it for the first time, choose the first one which will give you 2 concurrent devices to start with. You can anytime purchase a new license for extending number of users.</li>
</ul>

<p><img src="/images/openvpn-guide/choose-ami.png" alt="alt text1" /></p>

<ul>
<li>Now click on <code>select</code> when you have choosen your AMI</li>
<li>You will be prompted with OpenVPN service cost for each instance type you spin up. This will be added to your AWS billing. I would always choose <code>t2.micro</code> instance type as OpenVPN server does not need much memory to perform it's operations.</li>
</ul>

<p><img src="/images/openvpn-guide/cost.png" alt="alt text1" /></p>

<ul>
<li>Click on <code>continue</code> and choose instance type as <code>t2.micro</code></li>
<li>Click on <code>Next: Configure Instance Details</code></li>
<li>This is an important step. Make sure you choose your VPC if you have one and choose it's public subnet. If you do not have custom VPC and subnets, leave these settings as is. Make sure that its a public subnet as OpenVPN instance should be in a public subnet so it is accessible via web directly.</li>
<li>Click on <code>Next: Add Storage</code></li>
<li>Here you need to make sure the instance volume is encrypted. Otherwise you will get warning like <code>Volume (/dev/sda1) needs to be encrypted as encryption is enabled by default.</code> Click on <code>Encryption</code> dropdown and choose a KMS key which will encrypt your volume. Also make sure your instance volume type is <code>General Purpoise SSD (gp2)</code>. Sometimes it changes to <code>Magnetic (standard)</code> when you enable volume encryption</li>
<li>Click on <code>Next: Add Tags</code> and add the tags you need for this instance</li>
<li>Click on <code>Next: Configure Security Group</code></li>
<li>You need to select <code>Create a new security group</code>. Add security group name as <code>OpenVPN server SG</code>. Wait.. Hey, AWS already has filled in the group rules for you, thats awesome... isn't it?</li>
</ul>

<p><img src="/images/openvpn-guide/sg.png" alt="alt text1" /></p>

<ul>
<li>Click on <code>Review and Launch</code></li>
<li>Verify the details once in this final summary screen and click on <code>Launch</code></li>
<li>It will ask you to select a <code>key pair</code> create a new one as <code>OpenVPN-key-pair</code> and download it.</li>
<li>Now finally.. Click on <code>Launch Instances</code></li>
</ul>

<p>You are done with launching the instance.. Yassssss!! Above steps will launch your new server.</p>

<h3 id="step-2---assigning-elastic-ip-and-domain-%3A">Step 2 - Assigning elastic IP and domain :</h3>

<p>When your instance is up and running, you will see it's public IP given by AWS automatically. However, once you reboot this instance anytime, this IP will change. We do not want that. So we will associate an elastic IP to this instance so it stays no matter if the instance is stopped or rebooted.</p>

<ul>
<li>Select EC2 service from the same region where you have the OpenVPN instance</li>
<li>Click on <code>Elastic IPs</code></li>
<li>Click on <code>Allocate new address</code> and select <code>Allocate</code></li>
<li>Now you will see a new elasic IP in the list which is not associated with any instance</li>
<li>Select that IP and in the actions dropdown choose <code>Associate Address</code></li>
<li>You will see a new association form, keep resource type as <code>Instance</code> and select your new OpenVPN instance from the instance dropdown</li>
<li>Save the association</li>
<li>Now of you go back to the instance and see it's public IP, you will see the new elastic IP as its public IP.</li>
</ul>

<p>Now, you can associate a domain to this new public IP or you can keep as it is. It depends on your preference but I would recommend having a domain like <code>vpn.yourdomain.com</code> to access this server.</p>

<p>If you choose to have a domain, then this is the time when you need to point the A record of your domain to the new elastic public IP. For the consistency in remaining article, we are going to use <code>vpn.yourdomain.com</code>.</p>

<h3 id="step-3-%3A-initializing-up-the-openvpn-basic-settings-%3A">Step 3 : Initializing up the OpenVPN basic settings :</h3>

<p>Now, you will not be able to access openVPN directly. This is because you are yet to initiate the basic settings. For that, we need to ssh into the server.</p>

<ul>
<li>Use the key pair file <code>OpenVPN-key-pair.pem</code> to ssh into the instance. As in the security group port <code>22</code> is open for everyone with value <code>0.0.0.0/0</code>, you would be able to SSH to your instance from anywhere. (We will change that after the setup is completed)</li>
<li>Use ssh username as <code>openvpnas</code> as this comes default with the OpenVPN marketplace AMI</li>
<li>Once you login to the instance, you will see a setup wizard and it will ask you to agree to the terms and conditions</li>
<li>Now it will ask number of settings to you :</li>
</ul>

<pre><code class="bash">openvpnas@openvpnas2:# 

Welcome to OpenVPN Access Server Appliance 2.7.5

  System information as of Sat Oct 19 12:24:42 UTC 2019

  System load:  0.95              Processes:           98
  Usage of /:   26.7% of 7.69GB   Users logged in:     0
  Memory usage: 18%               IP address for eth0: 172.32.1.87
  Swap usage:   0%


          OpenVPN Access Server
          Initial Configuration Tool
------------------------------------------------------
OpenVPN Access Server End User License Agreement (OpenVPN-AS EULA)

    1. Copyright Notice: OpenVPN Access Server License;
       Copyright (c) 2009-2019 OpenVPN Inc. All rights reserved.
       "OpenVPN" is a trademark of OpenVPN Inc.
    2. Redistribution of OpenVPN Access Server binary forms and related documents,
       are permitted provided that redistributions of OpenVPN Access Server binary
       forms and related documents reproduce the above copyright notice as well as
       a complete copy of this EULA.
    3. You agree not to reverse engineer, decompile, disassemble, modify,
       translate, make any attempt to discover the source code of this software,
       or create derivative works from this software.
    4. The OpenVPN Access Server is bundled with other open source software
       components, some of which fall under different licenses. By using OpenVPN
       or any of the bundled components, you agree to be bound by the conditions
       of the license for each respective component. For more information, you can
       find our complete EULA (End-User License Agreement) on our website
       (http://openvpn.net), and a copy of the EULA is also distributed with the
       Access Server in the file /usr/local/openvpn_as/license.txt.
    5. This software is provided "as is" and any expressed or implied warranties,
       including, but not limited to, the implied warranties of merchantability
       and fitness for a particular purpose are disclaimed. In no event shall
       OpenVPN Inc. be liable for any direct, indirect, incidental,
       special, exemplary, or consequential damages (including, but not limited
       to, procurement of substitute goods or services; loss of use, data, or
       profits; or business interruption) however caused and on any theory of
       liability, whether in contract, strict liability, or tort (including
       negligence or otherwise) arising in any way out of the use of this
       software, even if advised of the possibility of such damage.
    6. OpenVPN Inc. is the sole distributor of OpenVPN Access Server
       licenses. This agreement and licenses granted by it may not be assigned,
       sublicensed, or otherwise transferred by licensee without prior written
       consent of OpenVPN Inc. Any licenses violating this provision
       will be subject to revocation and deactivation, and will not be eligible
       for refunds.
    7. A purchased license entitles you to use this software for the duration of
       time denoted on your license key on any one (1) particular device, up to
       the concurrent user limit specified by your license. Multiple license keys
       may be activated to achieve a desired concurrency limit on this given
       device. Unless otherwise prearranged with OpenVPN Inc.,
       concurrency counts on license keys are not to be divided for use amongst
       multiple devices. Upon activation of the first purchased license key in
       this software, you agree to forego any free licenses or keys that were
       given to you for demonstration purposes, and as such, the free licenses
       will not appear after the activation of a purchased key. You are
       responsible for the timely activation of these licenses on your desired
       server of choice. Refunds on purchased license keys are only possible
       within 30 days of purchase of license key, and then only if the license key
       has not already been activated on a system. To request a refund, contact us
       through our support ticket system using the account you have used to
       purchase the license key. Exceptions to this policy may be given for
       machines under failover mode, and when the feature is used as directed in
       the OpenVPN Access Server user manual. In these circumstances, a user is
       granted one (1) license key (per original license key) for use solely on
       failover purposes free of charge. Other failover and/or load balancing use
       cases will not be eligible for this exception, and a separate license key
       would have to be acquired to satisfy the licensing requirements. To request
       a license exception, please file a support ticket in the OpenVPN Access
       Server ticketing system. A staff member will be responsible for determining
       exception eligibility, and we reserve the right to decline any requests not
       meeting our eligibility criteria, or requests which we believe may be
       fraudulent in nature.
    8. Activating a license key ties it to the specific hardware/software
       combination that it was activated on, and activated license keys are
       nontransferable. Substantial software and/or hardware changes may
       invalidate an activated license. In case of substantial software and/or
       hardware changes, caused by for example, but not limited to failure and
       subsequent repair or alterations of (virtualized) hardware/software, our
       software product will automatically attempt to contact our online licensing
       systems to renegotiate the licensing state. On any given license key, you
       are limited to three (3) automatic renegotiations within the license key
       lifetime. After these renegotiations are exhausted, the license key is
       considered invalid, and the activation state will be locked to the last
       valid system configuration it was activated on. OpenVPN Inc.reserves the
       right to grant exceptions to this policy for license holders under
       extenuating circumstances, and such exceptions can be requested through a
       ticket via the OpenVPN Access Server ticketing system.
    9. Once an activated license key expires or becomes invalid, the concurrency
       limit on our software product will decrease by the amount of concurrent
       connections previously granted by the license key. If all of your purchased
       license key(s) have expired, the product will revert to demonstration mode,
       which allows a maximum of two (2) concurrent users to be connected to your
       server. Prior to your license expiration date(s), OpenVPN Inc. will attempt
       to remind you to renew your license(s) by sending periodic email messages
       to the licensee email address on record. You are solely responsible for
       the timely renewal of your license key(s) prior to their expiration if
       continued operation is expected after the license expiration date(s).
       OpenVPN Inc. will not be responsible for any misdirected and/or undeliverable
       email messages, nor does it have an obligation to contact you regarding
       your expiring license keys.
   10. Any valid license key holder is entitled to use our ticketing system for
       support questions or issues specifically related to the OpenVPN Access
       Server product. To file a ticket, go to our website at http://openvpn.net/
       and sign in using the account that was registered and used to purchase the
       license key(s). You can then access the support ticket system through our
       website and submit a support ticket. Tickets filed in the ticketing system
       are answered on a best-effort basis. OpenVPN Inc. staff
       reserve the right to limit responses to users of our demo / expired
       licenses, as well as requests that substantively deviate from the OpenVPN
       Access Server product line. Tickets related to the open source version of
       OpenVPN will not be handled here.
   11. Purchasing a license key does not entitle you to any special rights or
       privileges, except the ones explicitly outlined in this user agreement.
       Unless otherwise arranged prior to your purchase with OpenVPN,
       Inc., software maintenance costs and terms are subject to change after your
       initial purchase without notice. In case of price decreases or special
       promotions, OpenVPN Inc. will not retrospectively apply
       credits or price adjustments toward any licenses that have already been
       issued. Furthermore, no discounts will be given for license maintenance
       renewals unless this is specified in your contract with OpenVPN Inc.

Please enter 'yes' to indicate your agreement [no]: yes

Once you provide a few initial configuration settings,
OpenVPN Access Server can be configured by accessing
its Admin Web UI using your Web browser.

Will this be the primary Access Server node?
(enter 'no' to configure as a backup or standby node)
&gt; Press ENTER for default [yes]: yes

Please specify the network interface and IP address to be
used by the Admin Web UI:
(1) all interfaces: 0.0.0.0
(2) eth0: 172.31.16.206
Please enter the option number from the list above (1-2).
&gt; Press Enter for default [2]: 1

Please specify the port number for the Admin Web UI.
&gt; Press ENTER for default [943]: 943

Please specify the TCP port number for the OpenVPN Daemon
&gt; Press ENTER for default [443]: 443

Should client traffic be routed by default through the VPN?
&gt; Press ENTER for default [yes]: yes

Should client DNS traffic be routed by default through the VPN?
&gt; Press ENTER for default [yes]: yes

Use local authentication via internal DB?
&gt; Press ENTER for default [yes]: yes

Private subnets detected: ['172.31.0.0/16']

Should private subnets be accessible to clients by default?
&gt; Press ENTER for EC2 default [yes]: yes

To initially login to the Admin Web UI, you must use a
username and password that successfully authenticates you
with the host UNIX system (you can later modify the settings
so that RADIUS or LDAP is used for authentication instead).

You can login to the Admin Web UI as "openvpn" or specify
a different user account to use for this purpose.

Do you wish to login to the Admin UI as "openvpn"?
&gt; Press ENTER for default [yes]: yes

&gt; Please specify your OpenVPN-AS license key (or leave blank to specify later):

Initializing OpenVPN...
Adding new user login...
useradd -s /sbin/nologin "openvpn"
Writing as configuration file...
Perform sa init...
Wiping any previous userdb...
Creating default profile...
Modifying default profile...
Adding new user to userdb...
Modifying new user as superuser in userdb...
Getting hostname...
Hostname: openvpnserver
Preparing web certificates...
Getting web user account...
Adding web group account...
Adding web group...
Adjusting license directory ownership...
Initializing confdb...
Generating init scripts...
Generating PAM config...
Generating init scripts auto command...
Starting openvpnas...

NOTE: Your system clock must be correct for OpenVPN Access Server
to perform correctly.  Please ensure that your time and date
are correct on this system.

Initial Configuration Complete!

You can now continue configuring OpenVPN Access Server by
directing your Web browser to this URL:

https://x.x.x.x:943/admin
Login as "openvpn" with the same password used to authenticate
to this UNIX host.

During normal operation, OpenVPN AS can be accessed via these URLs:
Admin  UI: https://x.x.x.x:943/admin
Client UI: https://x.x.x.x:943/

See the Release Notes for this release at:
   https://openvpn.net/vpn-server-resources/release-notes/
</code></pre>

<ul>
<li>Now you we need a password to login first time as an admin. For that run command</li>
</ul>

<pre><code>openvpnas@openvpnas2:~$ sudo passwd openvpn
Enter new UNIX password:
Retype new UNIX password:
passwd: password updated successfully
openvpnas@openvpnas2:~$
</code></pre>

<p>You are done with basic setup, we can now proceed with the web UI for further settings.</p>

<h3 id="step-4-%3A-accessing-openvpn-web-ui-%3A">Step 4 : Accessing OpenVPN Web UI :</h3>

<p>Now we will access the OpenVPN Web UI using the elastic IP with url https://x.x.x.x:943/admin where <code>x.x.x.x</code> is your elasic IP. You might be thinking that we have <code>vpn.yourdomain.com</code> setup so why are we using the elastic IP? We will get back to it shortly but for the first time we will need to use the IP.</p>

<ul>
<li>Visit https://x.x.x.x:943/admin which will say that it is insecure, click on advanced and proceed to visit the website</li>
</ul>

<p><img src="/images/openvpn-guide/admin-login.png" alt="alt text1" /></p>

<ul>
<li>Login with the username <code>openvpn</code> and the admin password you set earlier</li>
<li>Once you login for the first time, you will see a lisence agreement which you select <code>agree</code></li>
</ul>

<p><img src="/images/openvpn-guide/agree.png" alt="alt text1" /></p>

<ul>
<li>Now you will see a nice web UI as below :</li>
</ul>

<p><img src="/images/openvpn-guide/dashboard.png" alt="alt text1" /></p>

<ul>
<li>Go to <code>Configuration &gt; Network Settings</code> on the left hand side menu</li>
<li>You will see a setting <code>Hostname or IP Address</code>. Here we will now enter <code>vpn.yourdomain.com</code></li>
<li>Now click on <code>Save Settings</code></li>
<li>Now click on <code>Update running server</code></li>
</ul>

<p>Now we have the domain set up. You can open another tab and visit <code>https://vpn.yourdomain.com:943/admin</code> and it will work now!</p>

<h3 id="step-5-%3A-having-a-valid-ssl-%3A">Step 5 : Having a valid SSL :</h3>

<p>You must have observed that the SSL comes with the OpenVPN server is not trusted by browsers. So we will have a new CertBot SSL which will not show SSL warnings and errors.</p>

<ul>
<li>SSH to the openvpn server again</li>
<li>Type following commands to install certbot</li>
</ul>

<pre><code class="bash">sudo apt-get update
sudo apt-get install software-properties-common
sudo add-apt-repository universe
sudo add-apt-repository ppa:certbot/certbot
sudo apt-get update
sudo apt-get install -y certbot
</code></pre>

<p>Now we need to open port 80 <code>temporarily</code> on the security group of our OpenVPN server so that Certbot can verify that the server and domain. Certbot will temporarily spin up a webserver on our openVPN machine for the same.
- Go to AWS console and choose our OpenVPN server security group <code>OpenVPN server SG</code>
- In the inbound rules, add HTTP 80 rule with source <code>0.0.0.0/0, ::/0</code> to access tempoarary port 80 traffic</p>

<p>Now we can run Certbot</p>

<ul>
<li>SSH to the openvpn server again</li>
<li>Type following commands to request certbot certificate</li>
</ul>

<pre><code class="bash">sudo certbot certonly --standalone
</code></pre>

<p>It will ask you number of questions and then a domain name. Enter <code>vpn.yourdomain.com</code> and it will verify it using temporary web server on port 80.</p>

<p>Below is the output :</p>

<pre><code>openvpnas@openvpnas2:~$ sudo certbot certonly --standalone
Saving debug log to /var/log/letsencrypt/letsencrypt.log
Plugins selected: Authenticator standalone, Installer None
Enter email address (used for urgent renewal and security notices) (Enter 'c' to
cancel): support@yourdomain.com

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Please read the Terms of Service at
https://letsencrypt.org/documents/LE-SA-v1.2-November-15-2017.pdf. You must
agree in order to register with the ACME server at
https://acme-v02.api.letsencrypt.org/directory
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
(A)gree/(C)ancel: A

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Would you be willing to share your email address with the Electronic Frontier
Foundation, a founding partner of the Let's Encrypt project and the non-profit
organization that develops Certbot? We'd like to send you email about our work
encrypting the web, EFF news, campaigns, and ways to support digital freedom.
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
(Y)es/(N)o: N
Please enter in your domain name(s) (comma and/or space separated)  (Enter 'c'
to cancel): vpn.yourdoman.com
Obtaining a new certificate
Performing the following challenges:
http-01 challenge for vpn.yourdoman.com
Waiting for verification...
Cleaning up challenges

IMPORTANT NOTES:
 - Congratulations! Your certificate and chain have been saved at:
   /etc/letsencrypt/live/vpn.youdomain.com/fullchain.pem
   Your key file has been saved at:
   /etc/letsencrypt/live/vpn.youdomain.com/privkey.pem
   Your cert will expire on 2020-01-14. To obtain a new or tweaked
   version of this certificate in the future, simply run certbot
   again. To non-interactively renew *all* of your certificates, run
   "certbot renew"
 - If you like Certbot, please consider supporting our work by:
</code></pre>

<p>Now we are concerned with 2 files : <code>privkey.pem</code> and <code>fullchain.pem</code>. But first, go back to the security group and remove the rule for <code>HTTP port 80</code> as we do not need it anymore!</p>

<p>Now we will view contents of these files and copy them locally. You can use following commands to show their text content, you need to manually copy them and make new files locally with same name and paste the respective contents.</p>

<pre><code class="bash"># Make sure you replace vpn.youdomain.com with your expected domain or ip
cat /etc/letsencrypt/live/vpn.youdomain.com/fullchain.pem
cat /etc/letsencrypt/live/vpn.youdomain.com/privkey.pem
</code></pre>

<p>Final step is to update these certificates on OpenVPN web UI. 
- Visit <code>https://vpn.yourdomain.com:943/admin</code> and login with the admin credentials used earlier
- Go to <code>Configuration &gt; Web Server</code> on the left hand side menu
- You will 3 file upload options fot uploading certifiates
- Upload local <code>fullchain.pem</code> for <code>Certificate</code> file upload
- Upload local <code>privkey.pem</code> for <code>Private Key</code> file upload
- Click on <code>Validate</code> and you will see new certificate results under <code>Validation Results</code>
- Now click on <code>Save</code>
- Click on <code>Update running server</code> if it pops up</p>

<p>And now you are done! Logout and login again or a new tab and you will see that new SSL works with no certificate warnings.</p>

<h3 id="step-6-%3A-creating-an-openvpn-user-%3A">Step 6 : Creating an OpenVPN user :</h3>

<p>You should never ever use the admin user <code>openvpn</code> to connect via vpn client! We will now create a new user.</p>

<ul>
<li>Visit <code>https://vpn.yourdomain.com:943/admin</code> and login with the admin credentials used earlier</li>
<li>Go to <code>User Management &gt; User Permissions</code> on the left hand side menu</li>
<li>Enter new username <code>vpnclientuser</code> and click on <code>More Settings</code> Dropdown to set a new passsword</li>
<li>Click on <code>Save Settings</code> and <code>Update existing server</code></li>
</ul>

<h3 id="final-step-%3A-login-with-vpn-%3A">Final step : Login with VPN :</h3>

<p>Go to your VPN client and enter host as <code>vpn.yourdomain.com</code> with username as <code>vpnclientuser</code> and the password you set for it. And Done!! You are connected.</p>

<p>If you do not have VPN client follow below steps :</p>

<ul>
<li>Visit <code>https://vpn.yourdomain.com:943</code> (Note that this url is not the admin login but a user login without /admin at the end)</li>
<li>Login with the user credentials with username as <code>vpnclientuser</code> and the password you set for it</li>
<li>Now you will see options to download VPN client or reset the user password if needed</li>
</ul>

<h3 id="cleanup-%3A">Cleanup :</h3>

<p>Now you are done with the OpenVPN server setup. I would recommend to remove the HTTP 22 inbound rule from <code>OpenVPN server SG</code> security group associated with the VPN server. This is because you would only need SSH access when you want to check logs or update some setup on OpenVPN. You can always go to AWS and open the port when needed.</p>

<p>Alternatively, change the source to your specific IP from which you SSH to the instance so that it is not open to the whole wide internet.</p>
]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[Manage laravel .env file using AWS parameter store]]></title>
            <link href="https://techsemicolon.github.io/blog/2019/07/10/aws-manage-env-file-using-ssm-laravel/"/>
            <updated>2019-07-10T00:00:00+00:00</updated>
            <id>https://techsemicolon.github.io/blog/2019/07/10/aws-manage-env-file-using-ssm-laravel/</id>
            <content type="html"><![CDATA[<p>When you have an application hosted on AWS EC2 instances which runs on an environment file, like laravel framework needs <code>.env</code> environment file, it is always a pain to manage environment variables.</p>

<p>Specially when you have multiple EC2 instances running for production on an auto-scaling setup. Please note that these are not host OS environment variable, but the application framework's environment variables in the respective env file.</p>

<p>You may alternatively call them application configuration files. You mostly do not add them in git or bitbucket due to the possibility of them containing sensitive information, e.g. database passwords, AWS access credentials etc..</p>

<h3 id="problem-statement-%3A">Problem statement :</h3>

<ul>
<li>You have environment .env file inside your EC2 AMI</li>
<li>When you spin up an instance, the .env file comes from the AMI specified in the launch configuration, considering you have auto-scaling set up</li>
<li>If you want to update any existing .env variable, you need to spin up new AMI and update production servers</li>
</ul>

<p>If your production environment has a setup like above, you may have experienced bit of pain in changing .env variables. Specially when there is a quick turnaround required due to some urgency or bug where you need to update an .env file variable asap.</p>

<h3 id="ec2-user_data-coming-to-rescue-%3A">EC2 user_data coming to rescue :</h3>

<p>When you spin up a new instance, you have an option in <code>Step 3: Configure Instance Details</code> screen inside <code>Advanced Details</code> called <code>user_data</code>. This looks something like below :</p>

<p>You can write shell scripts in text area or upload a bash file as per your choice. When you launch an instance in Amazon EC2, these shell scripts will be run after the instance starts. You can also pass cloud-init directives but we will stick to shell script for this use case to fetch the environment variables from systems manager parameter store and generate an environment file, in our case <code>.env</code> file under laravel root.</p>

<p><img src="/images/aws-ansible/user-data.png" alt="alt text1" /></p>

<h3 id="setting-up-variables-in-parameter-store-%3A">Setting up variables in parameter store :</h3>

<p>AWS has service called <code>Systems Manager</code> which contains a sub-service for resource sharing. This is called <code>Parameter Store</code>. There are couple of ways to store a parameter inside this service. We will be using <code>SecureString</code> option which makes sure the paramater value(which in our case is the enviromnent file contents) are encrypted inside AWS.</p>

<p>You may think that instead of storing entire .env file content into a single text-area, why should we not create multiple paremeters for each variable in the .env file? That's a perfectly valid point. However, storing it in one paramter store decreases overall maintenability and also makes the shell script to retrive those values very compact.</p>

<p>You can use below steps to store your <code>.env</code> file inside parameter store :</p>

<ol>
<li>Login to AWS console and switch to the region which contains your production setup</li>
<li>Go to <code>Systems Manager</code> and click on <code>Parameter Store</code></li>
<li>Click on <code>Create Parameter</code></li>
<li>Add <code>Name</code> and <code>Description</code></li>
<li>Select <code>Tier</code> as <code>Standard</code></li>
<li>Select <code>Type</code> as <code>SecureString</code></li>
<li>Select KMS key which managed encryption as per your choice</li>
<li>Enter entire <code>.env</code> contents into the text-area</li>
<li>Click on <code>Create Parameter</code> to save the parameter</li>
</ol>

<p><img src="/images/aws-ansible/create-parameter.png" alt="alt text1" /></p>

<h3 id="accessing-the-paremeter-store-values-%3A">Accessing the paremeter store values :</h3>

<p>Your EC2 instance which runs the application will be accessing these parameter store values. So you need to make sure your instance IAM role has following  permission in its policy.</p>

<pre><code class="json">{
    "Version": "2012-10-17",
            "Statement": [
        {
            "Sid": "VisualEditor1",
            "Effect": "Allow",
            "Action": [
                "ssm:GetParameters",
                "ssm:GetParameter",
            ],
            "Resource": [
                "arn:aws:ssm:*:*:parameter/*"
            ]
        }
    ]
}
</code></pre>

<h3 id="shell-script-to-generate-.env-%3A">Shell script to generate .env :</h3>

<p>We will be using following shell script to generate <code>.env</code> :</p>

<pre><code class="bash">#!/bin/bash

# Please update below varoables as per your production setup
PARAMATER="APP_ENV"
REGION="us-west-1"
WEB_DIR="/var/www/html"
WEB_USER="www-data"

# Get parameters and put it into .env file inside application root
aws ssm get-parameter --with-decryption --name $PARAMATER --region $REGION | jq '.Parameter.Value' &gt; $WEB_DIR/.env

# Clear laravel configuration cache
cd $WEB_DIR
chown $WEB_USER. .env
sudo -u $WEB_USER php artisan config:clear
</code></pre>

<h3 id="putting-pieces-together-%3A">Putting pieces together :</h3>

<p>Let us now consider a very generic overview of how these pieces will fit together :</p>

<ul>
<li>You will have your <code>.env</code> file stored in AWS systems manager parameter store with encryption enabled at rest</li>
<li>When a new instance will spin up, it will pull the env string and put into an <code>.env</code> file. This will happen using <code>user_data</code> setting</li>
<li>It will clear the application env cache or any dependent commands to take new environmental file into effect</li>
</ul>

<h3 id="fundamental-implementation-situations-%3A">Fundamental implementation situations :</h3>

<p>Let's say you have added a new variable in your env paramater group. You expect it to reflect ASAP in following situations :</p>

<ul>
<li><strong>All the new EC2 instances which will spin up after that point should always use the new env file variables</strong> :</li>
</ul>

<p>This can be easily implemented as we discussed earlier using <code>user_data</code>. When you spin up an instance manually you can add the above shell script to pull latest .env from parameter group in the <code>user_data</code> field.</p>

<p>If you have auto-scaling enabled, make sure your launch configuration or launch template has the <code>user_data</code> field set with the shell script we discussed in the previous section. This will then make sure, whenever a new EC2 instance will spin up, it will always fetch the environmental paramater first from AWS systems manager's parameter group store and then make a branch new <code>.env</code> file.</p>

<ul>
<li><strong>The existing instances which are already running should fetch the updated env file variables</strong> :</li>
</ul>

<p>Let's first take out the case where you have instance not in any auto-scaling group. You can then manually SSH into instance and fetch the new .env. (Or automate it using Solution B)</p>

<p>But in here main point of concern is when you have autoscaling setup and production is running on multiple instances. This is an area where we can have 2 solutions. First one is very easy to implement whereas second one can be a pain. Let's discuss both :</p>

<p><code>Solution A</code> :</p>

<p>From your existing auto-scaling instances, start terminating an instance one by one. Your auto-scaling setup will then spin up new instances. As we discussed earlier, considering your launch configuration already has the shell script to pull updated environment variables from parameter group at the instance start from <code>user_data</code> setting, the new instances will be ready with updated environmental veriables in their <code>.env</code> files.</p>

<p>To add more automation, you may also do the termination activity using a lambda function or ansible based on a trigger when systems manager's parameter group is updated.</p>

<p><code>Solution B</code> :</p>

<p>This is important for applications where there ephemeral storage is important for some ongoing tasks. If we terminate the instances, the production application will lose some of it's ongoing process data. In this case we need to find an automated way to run the shell script on all those running instances, to update their <code>.env</code> variables.</p>

<p>In this case, you can use AWS lambda for this purpose. The bottom line of this is <code>When systems manager's parameter group is updated, it will trigger a lambda function. That lambda function will SSH into all your running production instances and update the .env file</code>.</p>

<p>There is already a github repo I have added sometime back on running SSH commands on EC2 instances. You can <a href="https://github.com/techsemicolon/ec2-run-commands-log-output">click here</a> to know more about it.</p>

<h3 id="my-two-cents-%3A">My two cents :</h3>

<p>This may definitely appear as an overhead... But as your application becomes large, setting these things up will make your life so much easier.</p>
]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[Ansible everything you need to know about set_facts]]></title>
            <link href="https://techsemicolon.github.io/blog/2019/07/07/ansible-everything-you-need-to-know-about-set-facts/"/>
            <updated>2019-07-07T00:00:00+00:00</updated>
            <id>https://techsemicolon.github.io/blog/2019/07/07/ansible-everything-you-need-to-know-about-set-facts/</id>
            <content type="html"><![CDATA[<p>If you have seen lot of ansible playbook examples, <code>set_facts</code> module is very common in most of them. Let us dive little deeper to know what is it and how it may help you to write dynamic playbooks.</p>

<h3 id="the-jargon-%60set_facts%60--%3A">The jargon <code>set_facts</code>  :</h3>

<p>If you just read <code>set_facts</code> in an ansible playbook, it is really hard to interpret what it really means. You may think like it is setting some kind of facts but what facts? I had the same doubt and I was little overwhelmed by the terminology in here. But, to understand in generic terms :</p>

<p><code>set_facts</code> module sets variables once you know their values and optionally deciding if you need their values to be set or not.</p>

<p>You may set simple variables in ansible using <code>vars</code>, <code>vars_file</code> or <code>include_vars</code> modules, however you know their values beforehand. In case of <code>set_facts</code>, you set variables <code>on the fly</code> depending on certain task results. These variables will be available to be used in the subsequent plays during an ansible playbook execution.</p>

<h3 id="let%27s-see-a-real-life-use-case-%3A">Let's see a real life use case :</h3>

<p>Before diving into an actual playbook and overal syntax, let's first take a real life use case, which will help us connect the dots.</p>

<p>Use case : We need to spin up an instance on AWS and then add it into an existing AWS Target Group.</p>

<p>Known Variables : We will have some known variables like the instance AMI id and the instance type.</p>

<p>Unkwnon Variables : To add an instance to target group, we need the instance id. However, until that instance is spun up, we will not have the instance id. This will be set on the fly once instance is spun up.</p>

<p>In this case, we will use known variables to spin up an instance. Once that task is done, we will get an instance id from AWS. Thats a <code>fact</code> which we have come across from that task. We will set it to a variable using <code>set_facts</code> module and then it can be used later to add instance into an existing AWS Target Group.</p>

<h3 id="register-and-set_facts-go-hand-in-hand-%3A">Register and set_facts go hand in hand :</h3>

<p>Until you have receieved a factual information or to be specific, a task result, you do not have facts to set using <code>set_facts</code> module. This is why I always feel <code>register</code> module and <code>set_facts</code> module go hand in hand.</p>

<p>Please note that, there are lots of other ways to get factual information from a task and <code>register</code> is not the only way. But it is one of the most common ways you would get facts. Some other modules to get factual information can be <code>ansible_facts</code> to get package information (package_facts) from a host. The possibilities are much more.</p>

<h3 id="set_facts-is-host-specific-%3A">set_facts is host specific :</h3>

<p>A very important thing to note that when you set a fact using <code>set_facts</code> module, it is specific to the host within which task is currently running. As documentation says : <code>Variables are set on a host-by-host basis just like facts discovered by the setup module.</code> If your playbook has multiple hosts then you can not share a fact set using <code>set_facts</code> from one host to another.</p>

<h3 id="diving-into-an-example-%3A">Diving into an example :</h3>

<p>Let's take the use case we discussed earlier and make a simple playbook for it. We will have following structure :</p>

<pre><code>ReleaseAMIUpdates/
 config.yml
 env.yml
 playbook.yml
 setup.sh
</code></pre>

<p>Please note that you may have more detailed structure based on your preferences. This article is about exploring <code>set_facts</code>, so we will focus more on its implementation.</p>

<ul>
<li>config.yml :</li>
</ul>

<p>This file will have the configuration variables which rarely change.</p>

<pre><code class="yml">vpc_id: vpc-12345678
ec2_iam_role: ec2-iam-role-name
instance_type: t2.micro
instance_volume_in_gb: 30
instance_security_group: ec2-security-group-name
ami_id: ami-12345678
instance_key_name: ansible-instance.pem
</code></pre>

<ul>
<li>env.yml :</li>
</ul>

<p>This file will have the configurations which are sensitive and may change .</p>

<pre><code class="yml">region: us-west-1
aws_access_key: your_aws_access_key
aws_secret_key: your_aws_secret_key
target_group: Test Ansible Target Group
</code></pre>

<ul>
<li>setup.sh :</li>
</ul>

<p>This file will have any user-data boostrap commands you need to run as soon as new instance is spun up. We will use this to install nginx so that we can server web traffic with a simple web page.</p>

<pre><code class="bash">#!/bin/bash

# Update Package Lists
apt-get update

# Install add-apt-repository dependencies
apt-get install software-properties-common -y
apt-get install python-software-properties -y

# Update Package Lists
apt-get update -y

# Install nginx 
apt-get -y install nginx
</code></pre>

<p>Now you have above yml files set up, these files will act as environment variable files. We will refer the configurations specified above as variables in our playbook.</p>

<ul>
<li>playbook.yml :</li>
</ul>

<p>This file will contain all palybook tasks.
</p>

<pre><code class="yaml"># create a launch configuration using an AMI image and instance type as a basis
- name: Launch new AMI Release
  hosts: localhost
  connection: local
  vars_files:
    - ./env.yml
    - ./config.yml

  tasks:

  #  Get VPC public subnet details as it will be needed later while launching the sandbox instance
  - name: Get VPC Subnet Details
    ec2_vpc_subnet_facts:
      aws_access_key: "{{ aws_access_key }}"
      aws_secret_key: "{{ aws_secret_key }}"
      region: "{{ region }}"
      filters:
        vpc-id: "{{ vpc_id }}"
        "tag:Availability": "Public"
    # Save the result json in variable subnet_facts_public
    register: subnet_facts_public

  - name: Get VPC Subnet ids which are available and public
    set_fact:
      vpc_subnet_id_public: "{{ subnet_facts_public.subnets|selectattr('state', 'equalto', 'available')|map(attribute='id')|list|random }}"

  # Launch instance with required settings
  - name: Launch new instance
    ec2:
      key_name: "{{ instance_key_name }}"
      aws_access_key: "{{ aws_access_key }}"
      aws_secret_key: "{{ aws_secret_key }}"
      region: "{{ region }}"
      image: "{{ ami_id }}"
      instance_profile_name: "{{ ec2_iam_role }}"
      vpc_subnet_id: "{{ vpc_subnet_id_public }}"
      instance_type: "{{ instance_type }}"
      group: "{{ instance_security_group }}"
      assign_public_ip: False
      # All commands specified in below will run as soon as instance is launched
      user_data: "{{ lookup('file', 'setup.sh') }}"
      wait: True
      wait_timeout: 500
      volumes: 
        - device_name: /dev/sda1
          volume_size: "{{ instance_volume_in_gb }}"
          volume_type: gp2
          encrypted: True
          delete_on_termination: True
      instance_tags:
        Name: Ansible-Test-Instance
    register: ec2

  # Get instance id from registered facts in ec2
  - name: Get instance id from registered facts in ec2
    set_fact:
      new_instance_id: "{{ ec2.instance_ids[0] }}"

  # Add newly created instance into target group
  - name: Add newly created instance into target group
    elb_target_group:
      name: "{{ target_group }}"
      aws_access_key: "{{ aws_access_key }}"
      aws_secret_key: "{{ aws_secret_key }}"
      region: "{{ region }}"
      target_type: instance
      health_check_interval: 30
      health_check_path: /health
      health_check_protocol: http
      health_check_timeout: 15
      healthy_threshold_count: 2
      unhealthy_threshold_count: 2
      protocol: http
      port: 80
      vpc_id: "{{ _vpc_id }}"
      successful_response_codes: "200"
      targets:
        - Id: "{{ new_instance_id }}"
          Port: 80
      state: present

</code></pre>

<p>
Lets walk through each task in above <code>playbook.yml</code> first before we run it :</p>

<ol>
<li>We already know our vpc id. But to spin up an instance, we will need to get subnet id. We will use ansible module <code>ec2_vpc_subnet_facts</code> to get the public subnets. We will register that result into <code>subnet_facts_public</code> variable.</li>
<li>We will use <code>subnet_facts_public</code> variable to parse its content and get a public subnet which is available chosen randomly from set of available public subnets from the results. The type of parsing used is called <code>jinja</code> which comes within ansible. Once we have that fact, we will set it using <code>set_facts</code> into <code>vpc_subnet_id_public</code> variable on the fly.</li>
<li>We will launch new instance and then get its information. We will register that into <code>ec2</code> variable.</li>
<li>We will use <code>ec2</code> variable to parse its content and get the instance id of newly spun up instance. Once we have that fact, we will set it using <code>set_facts</code> into <code>new_instance_id</code> variable on the fly.</li>
<li>Finally we will update our target group and add this instance into its targets.</li>
</ol>

<h3 id="conditionally-set-facts-%3A">Conditionally set facts :</h3>

<p>You might need to set a fact using <code>set_facts</code> module when another variable or result registered contains some dependent value. In such case you can use <code>when</code> conditional.</p>

<p>Example :</p>

<p></p>

<pre><code class="yaml">- name: Get VPC Subnet ids which are available and public
    set_fact:
      vpc_subnet_id_public: "{{ subnet_facts_public.subnets|selectattr('state', 'equalto', 'available')|map(attribute='id')|list|random }}"
    when: region == "us-west-2" 
</code></pre>

<p></p>

<h3 id="caching-a-set-fact-%3A">Caching a set fact :</h3>

<p>You can cache a fact set from <code>set_facts</code> module so that when you execute your playbook next time, it's retrieved from cache. You can set <code>cacheable</code> to <code>yes</code> to store variables across your playbook executions using a fact cache. You may need to look into precedence strategies used by ansible to evaluate the cacheable facts mentioned in their <a href="https://docs.ansible.com/ansible/latest/modules/set_fact_module.html?highlight=set_facts">documentation</a>.</p>
]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[Ansible AWS rolling AMI update with zero downtime]]></title>
            <link href="https://techsemicolon.github.io/blog/2019/07/01/ansible-aws-rolling-ami-update-with-zero-downtime/"/>
            <updated>2019-07-01T00:00:00+00:00</updated>
            <id>https://techsemicolon.github.io/blog/2019/07/01/ansible-aws-rolling-ami-update-with-zero-downtime/</id>
            <content type="html"><![CDATA[<p>If you have website hosted on AWS with an Auto Scaling enabled, doing AMI rolling updates manually is a pain. But ansible makes it so much easy for you. Let's understand how you can save time and efforts for AMI rolling updates with zero downtime.</p>

<h3 id="what-is-a-rolling-ami-update-%3A">What is a rolling AMI update :</h3>

<p>When you have Auto Scaling enabled, AWS will scale up and down your setup by increasing or decreasing number of instances automatically based on server load and your auto scaling policies. AWS uses an instance template called <code>Launch Configuration</code> using which it understands what AMI to use when spinning up new instances automatically to scale up.</p>

<p>Now, lets assume that you have 4 instances currently in-service associated with your auto scaing with their AMI version as <code>V1</code>. Now you need to release a new AMI version <code>V2</code>. What you will ideally do is :</p>

<ul>
<li>Create a new launch configuration which points to new AMI version V2. To do it manually you will basicaly <code>copy</code> your existing launch configuration and update AMI id.</li>
<li>Edit your Auto Scaling group and associate it with newly created launch configuration.</li>
<li>By just doing above steps will not update the existing in-service instances. You will terminate the existing in-service instances one by one. Once an instance inside auto-scaling in-service listeners is terminated, auto scaling group will launch a new one to keep minimum number of instances in-service as per the auto scaling policy.</li>
<li>This new instance will now be from AMI version V2</li>
</ul>

<p>This is a rolling update, which most of the times is done manually. It takes approx 10-15 minutes to do it manually. Let's understand how you can do it under 2-3 minutes with ansible with 2-3 minutes rollback with just one configuration change.</p>

<h3 id="prerequisites-%3A">Prerequisites :</h3>

<p>You will need following before you start working on ansible playbook and it's tasks :</p>

<ul>
<li>You will need <code>ansible 2.8.x</code> and <code>boto3</code> installed on the system. Preferred way to install these is using <code>pip</code> installer.</li>
<li>You will need an AWS CLI user with access key and secret access key. I always prefer doing this in a non-production region first so that if you mess up anything, there is minimum worry. Let's say your production AWS region is <code>us-west-1</code> then you woul setup a clone in <code>us-west-2</code> and then test ansible playbook in there. You can use below IAM policy for the CLI user</li>
</ul>

<pre><code class="json">{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "ec2:*",
                "rds:*",
                "lambda:*",
                "autoscaling:*",
                "iam:PassRole",
                "elasticloadbalancing:*"
            ],
            "Resource": "*",
            "Condition": {
                "StringEquals": {
                    "aws:RequestedRegion": "us-west-2"
                }
            }
        }
    ]
}
</code></pre>

<h3 id="setup-%3A">Setup :</h3>

<p>We will have following structure :</p>

<pre><code>ReleaseAMIUpdates/
 config.yml
 env.yml
 playbook.yml
 startup.sh
</code></pre>

<ul>
<li>config.yml :</li>
</ul>

<p>This file will have the configuration variables which rarely change.</p>

<pre><code class="yml">project_lunch_config_name: Production Launch configuration
project_autoscaling_group_name: Prod Auto Scaling Group
project_vpc_id: vpc-12345678
project_ec2_iam_role: ec2-iam-role-name
project_instance_type: t2.micro
project_instance_volume_in_gb: 30
project_instance_security_group: ec2-security-group-name
</code></pre>

<ul>
<li>env.yml :</li>
</ul>

<p>This file will have the configurations which are sensitive and may change in each rolling update.</p>

<pre><code class="yml">project_region: us-west-1
project_aws_access_key: your_aws_access_key
project_aws_secret_key: your_aws_secret_key
project_golden_ami_id: ami-version-id
project_ami_version: V2
project_target_group_arn: arn:aws:elasticloadbalancing:us-west-2:123456789:targetgroup/Your-TargetGroup/233vc4441187369
</code></pre>

<ul>
<li>startup.sh :</li>
</ul>

<p>This file will have any user-data boostrap commands you need to run as soon as new instance is spun up.</p>

<pre><code class="bash">#!/bin/bash

# Add your commands here
# These will run as root
# Which means ~ refers to /root
</code></pre>

<p>Now you have above yml files set up, these files will act as environment variable files. We will refer the configurations specified above as variables in our playbook.</p>

<ul>
<li>playbook.yml :</li>
</ul>

<p>This file will contain all palybook tasks.
</p>

<pre><code class="yaml"># create a launch configuration using an AMI image and instance type as a basis
- name: Launch new AMI Release
  hosts: localhost
  connection: local
  vars_files:
    - ./env.yml
    - ./config.yml

  tasks:

  #  Get VPC subnet details as it will be needed later while setting up autoscaling group
  - name: Get VPC Subnet Details
    ec2_vpc_subnet_facts:
      aws_access_key: "{{ project_aws_access_key }}"
      aws_secret_key: "{{ project_aws_secret_key }}"
      region: "{{ project_region }}"
      filters:
        vpc-id: "{{ project_vpc_id }}"
        "tag:Availability": "Private"
    # Save the result json in variable subnet_facts
    register: subnet_facts

  # From the previously registered variable subnet_facts
  # Get filter subnet which are in avaible state
  # Use jinja to parse json and get list of ids
  # This list will be used directly while setting up autoscaling group
  - name: Get VPC Subnet ids which are available
    set_fact:
      vpc_subnet_ids: "{{ subnet_facts.subnets|selectattr('state', 'equalto', 'available')|map(attribute='id')|list }}"

  # Create new launch configuration as existing one can not be edited
  # This launch configuration will contain the new AMI
  - name: Configure new launch configuration
    ec2_lc:
      aws_access_key: "{{ project_aws_access_key }}"
      aws_secret_key: "{{ project_aws_secret_key }}"
      region: "{{ project_region }}"
      name: "{{ project_lunch_config_name }}"
      # This image Id will be the new golden AMI after release is complete
      image_id: "{{ project_golden_ami_id }}"
      instance_profile_name: "{{ project_ec2_iam_role }}"
      vpc_id: "{{ project_vpc_id }}"
      security_groups: ["{{ project_instance_security_group }}"]
      instance_type: "{{ project_instance_type }}"
      # All commands specified in below ./startup.sh will run as soon as instance is launched
      user_data_path: ./startup.sh
      volumes:
      - device_name: /dev/sda1
        volume_size: "{{ project_instance_volume_in_gb }}"
        volume_type: gp2
        iops: 3000
        delete_on_termination: true
        encrypted: true

  # Update autoscaling group and associate new launch configuration
  # As there is no AMI just to update an existing autoscaling group
  # We specify all options and ansible will match the name to update
  - name: Update Auto Scalling Group with new launch configuration
    ec2_asg:
      aws_access_key: "{{ project_aws_access_key }}"
      aws_secret_key: "{{ project_aws_secret_key }}"
      name: "{{ project_autoscaling_group_name }}"
      region: "{{ project_region }}"
      launch_config_name: "{{ project_lunch_config_name }}"
      default_cooldown: 180
      health_check_period: 300
      health_check_type: ELB
      target_group_arns: ["{{ project_target_group_arn }}"]
      desired_capacity: 4
      min_size: 4
      max_size: 6
      vpc_zone_identifier: "{{ vpc_subnet_ids }}"
      # Below settings will replace all existing instances in this autoscaling group
      # With instances of new AMI release
      # The replacing will happen in batches with 2 instances replaced at at time
      replace_all_instances: true
      replace_batch_size: 2
      # We will wait untill all newly replaced instances are healthy and in service
      # Max wait time will be 10 minutes after which ansible will time out
      # In case of timeout the activity will keep happening on AWS
      # Just that the terminal will not wait for the output and exit with code 0
      wait_for_instances: true
      wait_timeout: 600
      # Below tabs will be present on all production instances launched with new AMI
      tags:
      - Environment: Production
        Name : "Production instances | {{ project_ami_version }}"
        Project: Your Project Name
        Vesion : "{{ project_ami_version }}"
</code></pre>

<p>
Lets walk through each task in above <code>playbook.yml</code> first before we run it :</p>

<ol>
<li><p>Get VPC Subnet Details : The instances will be launched in a VPC. We will need the subnet ids from the VPC we will need instances to be present in. In here I have used a tag <code>Availability:Private</code> to only get private instances as in my setup, instances are not publically accessible from a public subnet.</p></li>
<li><p>Get VPC Subnet ids which are available : The 1st task will give us entire json details of VPC subnets. This task will filter and get only ids using jinja parsing of the json result.</p></li>
<li><p>Configure new launch configuration : We will create a new launch configuration. I have been very descriptive in the options used in this task to make sure it's easy to refer next time.</p></li>
<li><p>Update Auto Scalling Group with new launch configuration : This will associate the new launch configuration to an existing auto scaling group. Make sure your auto scaling group name matches to the one present already so that it's updated properly. The <code>replace_all_instances: true</code> makes sure we are rolling the new AMIs instantly. This task will wait for the instances to spin up and be <code>in-service</code> state. This is sepcified by <code>wait_for_instances</code> and <code>wait_timeout</code> options in this task.</p></li>
</ol>

<h3 id="running-the-playbook-%3A">Running the playbook :</h3>

<p>First step is to make sure you have correct variables set in the <code>env.yml</code> and <code>config.yml</code>. When you do it for the second time, you will just need to change <code>project_golden_ami_id</code> and <code>project_ami_version</code> variables.</p>

<p>Before running it directly, it's always safe to run it using <code>--check</code> mode as a dryrun, with -vv to have more verbose output :</p>

<pre><code class="bash">ansible-playbook playbook.yml -vv --check
</code></pre>

<p>Deploying the new AMI :</p>

<pre><code class="bash">ansible-playbook playbook.yml -vv
</code></pre>

<h3 id="rolling-back-the-update-%3A">Rolling back the update :</h3>

<p>If your AMI which was newly released had issues, you can easily roll it back by specifying old stable values in <code>project_golden_ami_id</code> and <code>project_ami_version</code> variables. Then you just need to deploy the playbook.</p>

<h3 id="why-to-invest-time-in-ansible-%3A">Why to invest time in ansible :</h3>

<p>As your AWS setup grows, the manual activities which were simple at first become start becoming an overhead. Plus, there is always a risk of errors when manual operations are concerned. Using an automation tool like ansible lets you do the same actions with 70-80% less time than you would need to do it manually. Also ansible playbooks become a reference documentation if you need to explain anyone from your team how AMI updates are performed.</p>

<h3 id="tracking-ansible-playbooks-in-git-repo-%3A">Tracking ansible playbooks in git repo :</h3>

<p>If you want to track these ansible playbooks in git, make sure you do not track the main <code>env.yml</code> file which has AWS CLI crednetials. That is why we have 2 separate files <code>env.yml</code> and <code>config.yml</code>.</p>

<h3 id="improvements-%3A">Improvements :</h3>

<p>If you would like, you can update the AWS CLI user IAM policy to add more granuler permissions which is always preferable.</p>
]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[AWS Load Balancer stickiness and load distribution]]></title>
            <link href="https://techsemicolon.github.io/blog/2019/04/19/aws-load-balancer-stickiness-load-distribution/"/>
            <updated>2019-04-19T00:00:00+00:00</updated>
            <id>https://techsemicolon.github.io/blog/2019/04/19/aws-load-balancer-stickiness-load-distribution/</id>
            <content type="html"><![CDATA[<p>AWS load balancing is an interesting cloud service which automatically distributes incoming application traffic across multiple available target servers, such as Amazon EC2 instances, containers, IP addresses, and Lambda functions. It helps the infrastructure to have high availability, automatic scaling and as a result makes application more fault tolerant.</p>

<ul>
<li>Quick question :</li>
</ul>

<p>As per the concept of AWS load balancer with autoscaling, if the traffic is increased which current servers can not handle, new server is launched automatically and added under the load balancer so that the traffic is distributed across available target servers.</p>

<p>Let's say for an example :</p>

<p>We have an Application load balancer(ALB) which has minimum 2 servers, maximum it can autoscale to 10 servers. Each server can serve user traffic for 50 users.</p>

<p>The server has autoscaling policy based on <code>CPUUtilization</code>, when server goes above 75% for CPUUtilization metrix, autoscaling shoul spin up new instance.</p>

<p>At 8AM there are 50 users, the traffic is distributed across 2 servers and everything is normal.
AT 10AM there are 95 user and the CPUUtilization is greater than 75% threashold, a new server spins up.</p>

<p>Now, at 10.15AM can you be sure that the traffic load is distributed evenly by the autoscaling?</p>

<ul>
<li>Let's find out :</li>
</ul>

<ol>
<li>Server spin up time :</li>
</ol>

<p>Server spin up time, also called as instance warmup time, is the duration in which server spin up is initiated and server is ready to server requests. This depends upon the configuration scripts and start up commands which are run when server is spinning up.</p>

<p>The instances use a configuration script to install and configure software before the instance is put into service. As a result, it takes around two or three minutes from the time the instance launches until it comes in service. This is not entirely in our hands and AWS internal infrastructure also contributes to this time. The actual time depends on several factors, such as the size of the instance and whether there are startup scripts to complete.</p>

<p>However, this is important to know how much time your server takes on an average to be ready. Because if your server takes on an average 15 minutes to spin up, all the increased traffic will still served by old overwhelmed servers for that 15 minute period.</p>

<p>AWS uses <a href="https://docs.aws.amazon.com/autoscaling/ec2/userguide/Cooldown.html">cooldown period</a> setting for simple autoscaling policy to handle the startup time.</p>

<ol start="2">
<li>Sticky session or stickyness of the load balancer :</li>
</ol>

<p><a href="https://docs.aws.amazon.com/elasticloadbalancing/latest/application/load-balancer-target-groups.html#sticky-sessions">Sticky session</a> or stickyness of load balancer the setting to route the traffic incoming requests for a particular session to the same target server that serviced the initial request for that session. In short, under load balancer having 3 servers S1, S2 and S3, if User A's first request was served by S2 server, his subsqeuent requests will be also served by S2 server until the request stickyness is expired or disabled or deliberatly updated(by sending differnet AWSALB cookie in request)</p>

<p>More interestingly, the load balancer will always distribute traffic in a round robin algorithm. This is done with each request without stickiness and done on each session with stickiness.</p>

<p>As soon as a new instance is spun up and joins the group, it will not immediately get all the traffic. but it will join in the pool of round robin distribution of incoming traffic.</p>

<p>With stickiness setting enabled, existing sessions <code>will still have all requests routed to existing instances</code>. Only <code>new</code> sessions may hit the new instance. Being round robin, new sessions may also get routed to the existing instances.</p>

<p>Without stickiness, request from existing users will immediately get routed to the new instance. Hence it's safe to say that how quickly traffic load will be equilized and distributed across all available instances will depend on stickiness.</p>

<p>Sticky session comes up with a setting of expiration. You can specify a time from 1 second to 7 days. This setting is really important and you should definitely pay attension to the value you are setting. If this value is very large, spinning up new instances when autoscaling kicks in will not be useful as existing traffic is still stick with old servers.</p>

<p>Also a key point to note that for sticky session expiration Period, type the cookie expiration period, in seconds. If you do not specify an expiration period, the sticky session lasts for the duration of the browser session.</p>

<ul>
<li>Know if you need sticky sessions :</li>
</ul>

<p>Even if the sticky session setting is a good choice, it's for the applications which maintain the session state on service target instance. For example, a php web server maintaining sessions in local filesystem of EC2 instance. In that case if user request is served by other EC2 instance, then user will be logged out die to that session not being present there.</p>

<p>However, if your session state is managed by a separate service like RDS, Redis, Elasticache etc which is independent of which target server is serving your request, you probably do not even need sticky sessions.</p>

<ul>
<li>The bottom line :</li>
</ul>

<p>Test and find the best settings as per your application when setting up auto-scaling policies. Because, if your server is not ready quickly when the application needs it for serving increased traffic, it's going to affect your application performance specially during peak hours.</p>
]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[Laravel use secure SSL connection while using AWS RDS]]></title>
            <link href="https://techsemicolon.github.io/blog/2019/04/10/laravel-rds-ssl-encryption-in-transit/"/>
            <updated>2019-04-10T00:00:00+00:00</updated>
            <id>https://techsemicolon.github.io/blog/2019/04/10/laravel-rds-ssl-encryption-in-transit/</id>
            <content type="html"><![CDATA[<p>Amazon Relational Database Service Amazon RDS is a cloud based web service that makes things easier to set up, operate, and scale a relational databases on the cloud. It has become one of the popular choices when setting up laravel database infrastructure.</p>

<ul>
<li>Quick question :</li>
</ul>

<p>If you are using AWS RDS in your laravel application, is your connection encrypted in transit? Or so ask other way around, is your laravel application connecting to AWS RDS using a secure SSL connection?</p>

<p>If you think that RDS comes up with secure encryption in transit, you are right, it implements SSL. However, is it turned on somehow by default or is it there when we use it directly? Not really.. I had a perception that my laravel app is secured in transit by SSL encryption until I found out its not.</p>

<ul>
<li>Let's find out :</li>
</ul>

<p>Connect to the environment/server/container where laravel is hosted and run tinker :</p>

<pre><code class="bash">php artisan tinker
</code></pre>

<p>Once, the tinker prompt is open, run following :</p>

<pre><code class="bash">&gt;&gt;&gt; DB::select("SHOW STATUS LIKE 'Ssl_cipher'")
</code></pre>

<p>If it gives output like following :</p>

<pre><code class="bash">=&gt; [
    {
        +"Variable_name": "Ssl_cipher",
        +"Value": "DHE-RSA-AES128-SHA",
    },
]
</code></pre>

<p>Then laravel application is connecting to AWS RDS via a secure SSL connection.</p>

<p>However, if the output is like this  :</p>

<pre><code class="bash">=&gt; [
    {
        +"Variable_name": "Ssl_cipher",
        +"Value": "",
    },
]
</code></pre>

<p>Then the connection is not sure. There are number of variables which you can help us get more information about the SSL connection paramaters. We checked <code>Ssl_cipher</code> above, you can also check <code>Ssl_version</code> which might give you blank or something like <code>TLSv1</code> if SSL is working.</p>

<p>To get all information about SSL connection run following in tinker prompt :</p>

<pre><code class="bash">&gt;&gt;&gt; DB::select("SHOW STATUS LIKE '%Ssl%'")
</code></pre>

<ul>
<li>Next steps to secure the connection :</li>
</ul>

<p>If you found out that the laravel application connection is not using SSL while connecting to AWS RDS, you can follow below steps to enable the same.</p>

<p>Firstly, let us understand how it works. When you connect to AWS RDS normally via mysql cli, you do :</p>

<pre><code class="bash">mysql -h myinstance.c9akciq32.rds-us-east-1.amazonaws.com -u username -p
</code></pre>

<p>You can pass SSL certificate using <code>--ssl-ca</code> option in above command like below :</p>

<pre><code class="bash">mysql -h myinstance.c9akciq32.rds-us-east-1.amazonaws.com --ssl-ca=/path/to/certificate-authority-file.pem -u username -p
</code></pre>

<p>Optionally, you can pass <code>-ssl-mode</code> and <code>--ssl-verify-server-cert</code>. For more details about this please refer mysql's official <a href="https://dev.mysql.com/doc/refman/5.7/en/encrypted-connection-options.html">documentation</a>.</p>

<p>Now let's get back to the original problem which we are here to solve. How we are going to do this in Laravel?</p>

<p>Step 1 : Downloading the <code>certificate authority file</code>. AWS RDS has a commonly published pem file called <code>rds-combined-ca-bundle.pem</code> which you can download directly from <a href="https://s3.amazonaws.com/rds-downloads/rds-combined-ca-bundle.pem">here</a>. It is an officially published pem file which will work in all default RDS SSL connections.</p>

<p>Step 2 : Save the downloaded file from step 1 inside a new directory called <code>RDSCerts</code> inside laravel root. Quick note that in this step itself, I would add this inside gitignore because there is no need to add pem and cert files inside the version control.</p>

<p>Step 3 : Laravel's database configurations are inside <code>config/database.php</code> file. It already has a <code>mysql</code> section. Let's not change that, lets copy that entirely into a new configuration section called <code>mysql_ssl</code> where we will also add the certification authority file in options like below :</p>

<pre><code class="php">'mysql_ssl' =&gt; [
    'driver' =&gt; 'mysql',
    'host' =&gt; env('DB_HOST', '127.0.0.1'),
    'port' =&gt; env('DB_PORT', '3306'),
    'database' =&gt; env('DB_DATABASE', 'forge'),
    'username' =&gt; env('DB_USERNAME', 'forge'),
    'password' =&gt; env('DB_PASSWORD', ''),
    'unix_socket' =&gt; env('DB_SOCKET', ''),
    'charset' =&gt; 'utf8mb4',
    'collation' =&gt; 'utf8mb4_unicode_ci',
    'prefix' =&gt; '',
    'prefix_indexes' =&gt; true,
    'strict' =&gt; false,
    'engine' =&gt; null,
    'options' =&gt; [    
        PDO::MYSQL_ATTR_SSL_CA =&gt; base_path('RDSCerts/rds-combined-ca-bundle.pem')
    ],
],
</code></pre>

<p>Important note, You might be thinking that when we need to pass <code>--ssl-verify-server-cert</code> option somehow from laravel's configuration as well. Don't worry it's enabled by default. If you want to disable it then you can pass <code>PDO::MYSQL_ATTR_SSL_VERIFY_SERVER_CERT = false</code> which I would not suggest.</p>

<p>There are more options about SSL which you can check in the official PDO <a href="https://www.php.net/manual/en/ref.pdo-mysql.php">documentation</a>.</p>

<p>Once you follow above 3 steps, you should be good to go. Cross check by running <code>DB::select("SHOW STATUS LIKE '%Ssl%'")</code> in tinker as we did earlier in this article. You should see ciphers and ssl version mentioned in the connection.</p>
]]></content>
        </entry>
    </feed>