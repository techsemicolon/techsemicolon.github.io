<!DOCTYPE html>
<html>
    <head lang="en">
        <title>Home &mdash; Tech.Semicolon</title>
        <meta charset="utf-8">
        <meta name="theme-color" content="#ffffff">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
                    <meta name="robots" content="noindex, follow">
        
        <!-- Meta Tags -->
        <meta name="description" content="" />
        <meta property="og:title" content="Home" />
        <meta property="og:type" content="article" />
        <meta property="og:url" content="https://techsemicolon.github.io" />
        <meta property="og:image" content="https://techsemicolon.github.io/images/logo.png" />
        <meta property="og:description" content="" /> 
        <meta property="og:site_name" content="Tech Semicolon" />
    
        <link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,500,500i,700,700i,900,900i&display=swap" rel="stylesheet">
        <link href="https://techsemicolon.github.io/components/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
        <link href="https://techsemicolon.github.io/css/style.css" rel="stylesheet" type="text/css" />

        <link rel="apple-touch-startup-image" href="https://techsemicolon.github.io/images/fav.png">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <link rel="shortcut icon" sizes="76x76" href="https://techsemicolon.github.io/images/fav.png">
        <link rel="shortcut icon" sizes="120x120" href="https://techsemicolon.github.io/images/fav.png">
        <link rel="shortcut icon" sizes="128x128" href="https://techsemicolon.github.io/images/fav.png">
        <link rel="shortcut icon" sizes="152x152" href="https://techsemicolon.github.io/images/fav.png">
        <link rel="shortcut icon" sizes="196x196" href="https://techsemicolon.github.io/images/fav.png">
        <link rel="shortcut icon" sizes="512x512" href="https://techsemicolon.github.io/images/fav.png">
        <link rel="shortcut icon" sizes="1024x1024" href="https://techsemicolon.github.io/images/fav.png">
        <link rel="shortcut icon" sizes="2048x2048" href="https://techsemicolon.github.io/images/fav.png">
        <link rel="apple-touch-icon" sizes="76x76" href="https://techsemicolon.github.io/images/fav.png">
        <link rel="apple-touch-icon" sizes="120x120" href="https://techsemicolon.github.io/images/fav.png">
        <link rel="apple-touch-icon" sizes="128x128" href="https://techsemicolon.github.io/images/fav.png">
        <link rel="apple-touch-icon" sizes="152x152" href="https://techsemicolon.github.io/images/fav.png">
        <link rel="apple-touch-icon" sizes="196x196" href="https://techsemicolon.github.io/images/fav.png">
        <link rel="apple-touch-icon" sizes="512x512" href="https://techsemicolon.github.io/images/fav.png">
        <link rel="apple-touch-icon" sizes="1024x1024" href="https://techsemicolon.github.io/images/fav.png">
        <link rel="apple-touch-icon" sizes="2048x2048" href="https://techsemicolon.github.io/images/fav.png">

        <link rel="stylesheet" href="https://techsemicolon.github.io/components/highlightjs/styles/github.css" />
        <link rel="alternate" type="application/atom+xml" href="https://techsemicolon.github.io/atom.xml" title="Tech.Semicolon activity feed" />
                    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
            <script>
            (adsbygoogle = window.adsbygoogle || []).push({
                google_ad_client: "ca-pub-6453469589570319",
                enable_page_level_ads: true
            });
            </script>
                                            </head>
    <body>
        <div id="fb-root"></div>
        <script>(function(d, s, id) {
              var js, fjs = d.getElementsByTagName(s)[0];
              if (d.getElementById(id)) return;
              js = d.createElement(s); js.id = id;
              js.src = 'https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v3.2&appId=1919280101503437&autoLogAppEvents=1';
              fjs.parentNode.insertBefore(js, fjs);
            }(document, 'script', 'facebook-jssdk'));
        </script>
        <header>
            <nav class="navbar navbar-expand-md navbar-dark fixed-top bg-header">
                <div class="container">
                    <a class="navbar-brand" href="https://techsemicolon.github.io/">
                        <img src="https://techsemicolon.github.io/images/logo.png" class="logo-img"/>
                    </a>
                    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                    <div class="collapse navbar-collapse" id="navbarCollapse">
                        <ul class="navbar-nav mr-auto">
                            <li class="nav-item"><a class="nav-link" href="https://techsemicolon.github.io/blog">Posts Archive</a></li>
                            <li class="nav-item"><a class="nav-link" href="https://techsemicolon.github.io/blog/categories">Categories</a></li>
                            <li class="nav-item"><a class="nav-link" href="https://techsemicolon.github.io/blog/tags">Tags</a></li>
                            <li class="nav-item"><a target="_blank" class="nav-link" href="https://github.com/techsemicolon">GitHub</a></li>
                            <li class="nav-item"><a class="nav-link" href="https://techsemicolon.github.io/about">About</a></li>
                        </ul>
                    </div>
                </div>
            </nav>
        </header>
        <main role="main" class="container">
            <div class="row">
                <div class="col-sm-12">
                    
            <article class="home-article">
            <header>
                <h2><a href="https://techsemicolon.github.io/blog/2019/01/06/laravel-module-pattern/">Laravel Module Pattern</a></h2>
            </header>
            <div class="home-article-body">
                <p>Laravel has a folder structure which ties similar entities of MVC together e.g. controllers in one folder, views into another. There are few set-backs of this approach :</p>

<ul>
<li>If your project scales exponentially having lot of module, each of these directories scale as well. It becomes difficult to maintain.</li>
<li>If you want to remove the module entirely, there are files scattered in different folders to consider. This sometimes lead to unused files still present in your project repository.</li>
<li>Re-using a module into different project is a hassle (unless you have it installed coumpled as a plugin via composer)</li>
<li>While using code editors, as the module files are in different folders. We might need to expand the folders in project sidebar to view them at a glance. The scattered folder structure makes it difficult to for a quick view. (Forgive me for being picky here ;))</li>
</ul>

<h4 id="implementation-%3A">Implementation :</h4>

<p>Before you dive in to further sections, if you are familier with basic concepts of larave, most part of the code will be very familier to you. Tt is really easier that you might think.</p>

<ul>
<li>Creating the module :</li>
</ul>

<p>Let's create a new folder called <code>Modules</code> in the project root. (You might want to create it inside app folder, I prefer it this way.) To use the <code>\Modules</code> namespace, we need to autoload it from composer.json in the psr-4 section.</p>

<pre><code class="json"> "autoload": {
        "psr-4": {
            "App\\": "app/",
            "Modules\\": "Modules/",
        }
    },
</code></pre>

<p>Let's dump the updated autoloads by doing following from terminal shell :</p>

<pre><code class="bash">composer dump-autoload
</code></pre>

<p>Now we are good to start with the first module. Let's consider a ticket module where user can submit a ticket from frontend and we store it into the database. We will not focus much on the actual implementation of  the ticketing ystem. We will emphasize on the structure of module.</p>

<ul>
<li>Create a new directory <code>Ticket</code>.</li>
</ul>

<p>Create a new directory <code>Ticket</code> inside <code>Modules</code> folder. I like to keep module names singular (Ticket instead of Tickets).</p>

<ul>
<li>Creating a service provider class :</li>
</ul>

<p>On a broader level, frameworks like laravel have special entry point wrappers which can find, register and instantiate the core functionalities. In case of Laravel it's the ServiceProvider class.</p>

<p>Create a new file <code>TicketServiceProvider.php</code> inside <code>Modules/Ticket</code>.</p>

<pre><code class="php">&lt;?php

namespace Modules\Ticket;

use Illuminate\Support\ServiceProvider as BaseServiceProvider;

class TicketServiceProvider extends BaseServiceProvider
{
    /**
     * Bootstrap any application services.
     *
     * @return void
     */
    public function boot() {}

    /**
     * Register any application services.
     *
     * @return void
     */
    public function register() {}
}
</code></pre>

<p>To make sure laravel considers this while booting up, we need to register it. Add this inside <code>config/app.php</code>'s  <code>providers</code> array :</p>

<pre><code class="php">App\Modules\Ticket\TicketServiceProvider::class,
</code></pre>

<ul>
<li>Creating migrations :</li>
</ul>

<p>We need to create a table to store new ticket data. Create a folder <code>Migrations</code> inside <code>Modules/Ticket</code>. 
Now we can create a new migration from terminal shell :</p>

<pre><code class="bash">php artisan make:migration create_tickets_table --path=Modules/Ticket/Migrations
</code></pre>

<p>It will create a new migration class inside <code>Modules/Ticket/Migrations</code> path. Let's add the table script :</p>

<pre><code class="php">&lt;?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class CreateTicketsTable extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::create('tickets', function (Blueprint $table) {
            $table-&gt;increments('id');
            $table-&gt;string('title')-&gt;nullable();
            $table-&gt;text('body')-&gt;nullable();
            $table-&gt;boolean('is_closed')-&gt;default(0);
            $table-&gt;timestamps();
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::dropIfExists('tickets');
    }
}
</code></pre>

<p>However, you must have noticed that this is not coming from Laravel's default <code>database/migrations</code> folder. We need to inform laravel to load this file as well for running migration. It can be done from service provider by adding following in boot method.</p>

<pre><code class="php">&lt;?php

namespace Modules\Ticket;

use Illuminate\Support\ServiceProvider as BaseServiceProvider;

class TicketServiceProvider extends BaseServiceProvider
{
    /**
     * Bootstrap any application services.
     *
     * @return void
     */
    public function boot() {

        // Load ticket module migrations from 
        // `Modules/Ticket/Migrations` folder path
        $this-&gt;loadMigrationsFrom(__DIR__.'/Migrations');
    }

    /**
     * Register any application services.
     *
     * @return void
     */
    public function register() {}
}
</code></pre>

<p>Now to run the migration from terminal shell :</p>

<pre><code class="bash">php artisan migrate
</code></pre>

<ul>
<li>Alternatively:</li>
</ul>

<p>If you are thinking <code>migrations are done very rarely, so why should we register it in service provider for a registration overhead?</code> Laravel has got you covered.</p>

<p>You can skip the step of doing <code>loadMigrationsFrom()</code> in service provider class. Instead you can specify the path while running migrations :</p>

<pre><code class="bash">php artisan migrate --path=Modules/Ticket/Migrations
</code></pre>

<p>If your project has CICD deployments, mostly it will just have the migrate command without the path option. The first method is preferable to keep it simple for deployments.</p>

<ul>
<li>Creating Model :</li>
</ul>

<p>Create a file <code>Ticket.php</code> inside <code>Modules/Ticket</code>. (You may create a <code>Models</code> folder inside <code>Modules/Ticket</code> and create model class inside it as per your preference.)</p>

<pre><code class="php">&lt;?php

namespace App\Modules\Ticket;

use Illuminate\Database\Eloquent\Builder;
use Illuminate\Database\Eloquent\Model;

class Ticket extends Model
{
    /**
     * The table associated with the model.
     *
     * @var string
     */
    protected $table = 'tickets';

    /**
     * The attributes that are mass assignable.
     *
     * @var array
     */
    protected $fillable = [
        'title',
        'body',
        'is_closed'
    ];

}
</code></pre>

<ul>
<li>Creating Controller :</li>
</ul>

<p>Create a new directory inside <code>Modules/Ticket</code> called <code>Http</code>. Let's create <code>TicketController.php</code> inside it :</p>

<pre><code class="php">&lt;?php

namespace Modules\Ticket\Http;

use Illuminate\Http\Request;
use App\Http\Controllers\Controller;
use Modules\Ticket\Ticket;

class TicketController extends Controller
{
    /**
     * Display a form for the resource.
     *
     * @return \Illuminate\Http\Response
     */
    public function create()
    {
        return view('tickets.create');
    }

    /**
     * Store a newly created resource in storage.
     *
     * @param  Request  $request
     * @param  UserRepository $users
     * 
     * @return \Illuminate\Http\Response
     */
    public function store(Request $request)
    {
        $request-&gt;validate([
            'title' =&gt; 'string|required|max:255',
            'body'  =&gt; 'string|required'
        ]);

        // Create new ticket
        $ticket = Ticket::create($request-&gt;only('title', 'body'));

        return redirect()-&gt;route('ticket.new')-&gt;withSuccess('Thank you for raising a ticket. We will get back to you at the earliest.');
    }
}
</code></pre>

<ul>
<li>Creating Routes :</li>
</ul>

<p>Create a new file called <code>TicketRoutes.php</code> inside <code>Modules/Ticket</code>.</p>

<pre><code class="php">&lt;?php 

Route::group(['namespace' =&gt; 'Modules\Ticket', 'middleware' =&gt; ['web', 'auth']], function () {

    Route::get('ticket/new', [ 'as' =&gt; 'ticket.new', 'uses' =&gt; 'TicketController@create' ]);
    Route::post('ticket/store', [ 'as' =&gt; 'ticket.store', 'uses' =&gt; 'TicketController@store' ]);
});
</code></pre>

<p>We need to tell laravel to register these routes as those are coming from a custom folder. We can do that from service provider :</p>

<pre><code class="php">&lt;?php

namespace Modules\Ticket;

use Illuminate\Support\ServiceProvider as BaseServiceProvider;

class TicketServiceProvider extends BaseServiceProvider
{
    /**
     * Bootstrap any application services.
     *
     * @return void
     */
    public function boot() {

        // Load ticket module migrations from 
        // `Modules/Ticket/Migrations` folder path
        $this-&gt;loadMigrationsFrom(__DIR__.'/Migrations');

        // Load routes
        $this-&gt;loadRoutesFrom(__DIR__.'/TickerRoutes.php');
    }

    /**
     * Register any application services.
     *
     * @return void
     */
    public function register() {}
}
</code></pre>

<ul>
<li>Creating Views :</li>
</ul>

<p>Create a new directory inside <code>Modules/Ticket</code> called <code>Views</code>. This will contain al views for our module. This is again not coming from Laravel's default <code>resources/views</code> folder. We need to tell laravel to load these views. It can be done from service provider by adding following in boot method.</p>

<pre><code class="php">&lt;?php

namespace Modules\Ticket;

use Illuminate\Support\ServiceProvider as BaseServiceProvider;

class TicketServiceProvider extends BaseServiceProvider
{
    /**
     * Bootstrap any application services.
     *
     * @return void
     */
    public function boot() {

        // Load ticket module migrations from 
        // `Modules/Ticket/Migrations`
        $this-&gt;loadMigrationsFrom(__DIR__.'/Migrations');

        // Load routes from `Modules/Ticket/TickerRoutes.php`
        $this-&gt;loadRoutesFrom(__DIR__.'/TickerRoutes.php');

        // Load views from `Modules/Ticket/Views`
        $this-&gt;loadViewsFrom(__DIR__.'/Views', 'ticket');
    }

    /**
     * Register any application services.
     *
     * @return void
     */
    public function register() {}
}
</code></pre>

<p>Note : Sometimes you may see <code>loadViewsFrom()</code> called without the second argument which is the package name. The difference is if you want to render a view without a package name you do <code>ticket.create</code> (file path : <code>Modules/Ticket/Views/ticket/create.blade.php</code>. If you specify package name, you do <code>ticket::create</code> (file path : <code>Modules/Ticket/Views/create.blade.php</code>)</p>

<p>Let's create a simple view <code>create.blade.php</code> which basically has a form :</p>

<p></p>

<pre><code>@extends('layouts.app')

@section('content')
    &lt;div class="panel panel-default"&gt;
        &lt;div class="panel-body"&gt;
            &lt;div class="col-md-4 col-md-offset-4"&gt;
                &lt;form role="form" method="POST" action="{{ route('ticket.store') }}"&gt;
                    @csrf
                    &lt;div class="form-group"&gt;
                        &lt;label&gt;Title *&lt;/label&gt;
                        &lt;input class="form-control" placeholder="Title for your ticket" id="title" name="title"&gt;
                        @if ($errors-&gt;has('title'))
                            &lt;span class="invalid-feedback" role="alert"&gt;
                                &lt;strong&gt;{{ $errors-&gt;first('title') }}&lt;/strong&gt;
                            &lt;/span&gt;
                        @endif
                    &lt;/div&gt;
                    &lt;div class="form-group"&gt;
                        &lt;label&gt;Description *&lt;/label&gt;
                        &lt;textarea class="form-control" placeholder="How can we assist you?" id="body" name="body"&gt;&lt;/textarea&gt;
                        @if ($errors-&gt;has('body'))
                            &lt;span class="invalid-feedback" role="alert"&gt;
                                &lt;strong&gt;{{ $errors-&gt;first('body') }}&lt;/strong&gt;
                            &lt;/span&gt;
                        @endif
                    &lt;/div&gt;
                    &lt;button type="submit" class="btn btn-primary"&gt;Submit Ticket&lt;/button&gt;
                &lt;/form&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
@endsection
</code></pre>

<p></p>

<ul>
<li>Creating Policies :</li>
</ul>

<p>If you would like to use policy to authorize the requests, create a file <code>TicketPolicy.php</code> inside <code>Modules/Ticket</code>.</p>

<pre><code class="php">&lt;?php

namespace App\Modules;

use App\User;


class TicketPolicy
{

    /**
     * Determines user access
     *
     * @param User $user
     * @return bool
     */
    public function index($user)
    {
        return true;
    }

    /**
     * Determines user access
     *
     * @param User $user
     * @return bool
     */
    public function store($user)
    {
        return true;
    }
}
</code></pre>

<p>As you must have thought by now, we need to register the policy using the laravel Gate contract inside service provider :</p>

<pre><code class="php">&lt;?php

namespace Modules\Ticket;

use Modules\Ticket\Ticket.php;
use Modules\Ticket\TicketPolicy.php;
use Illuminate\Contracts\Auth\Access\Gate as GateContract;
use Illuminate\Support\ServiceProvider as BaseServiceProvider;

class TicketServiceProvider extends BaseServiceProvider
{
    /**
     * Bootstrap any application services.
     *
     * @return void
     */
    public function boot(GateContract $gate) {

        // Load ticket module migrations from 
        // `Modules/Ticket/Migrations`
        $this-&gt;loadMigrationsFrom(__DIR__.'/Migrations');

        // Load routes from `Modules/Ticket/TickerRoutes.php`
        $this-&gt;loadRoutesFrom(__DIR__.'/TickerRoutes.php');

        // Load views from `Modules/Ticket/Views`
        $this-&gt;loadViewsFrom(__DIR__.'/Views', 'ticket');

        // Load the policies from `Modules/Ticket/TicketPolicy.php`
        $gate-&gt;policy(Ticket::class, TicketPolicy::class);
    }

    /**
     * Register any application services.
     *
     * @return void
     */
    public function register() {}
}
</code></pre>

<ul>
<li>Creating config files :</li>
</ul>

<p>We can have config files to access environmental variables specific for this module. For example in this ticket module let's say we need to configure an email to cc to. Create a file <code>TicketConfig.php</code> inside inside <code>Modules/Ticket</code>.</p>

<pre><code class="php">&lt;?php

return [

    /*
    |--------------------------------------------------------------------------
    | Email to cc for submitted tickets
    |--------------------------------------------------------------------------
    |
    | Type : string
    |
    */

    'ticket_cc_email' =&gt; env('TICKET_CC_EMAIL', null),

];
</code></pre>

<p>Now, let's register this inside service provider.</p>

<pre><code class="php">&lt;?php

namespace Modules\Ticket;

use Modules\Ticket\Ticket.php;
use Modules\Ticket\TicketPolicy.php;
use Illuminate\Contracts\Auth\Access\Gate as GateContract;
use Illuminate\Support\ServiceProvider as BaseServiceProvider;

class TicketServiceProvider extends BaseServiceProvider
{
    /**
     * Bootstrap any application services.
     *
     * @return void
     */
    public function boot(GateContract $gate) {

        // Load ticket module migrations from 
        // `Modules/Ticket/Migrations`
        $this-&gt;loadMigrationsFrom(__DIR__.'/Migrations');

        // Load routes from `Modules/Ticket/TickerRoutes.php`
        $this-&gt;loadRoutesFrom(__DIR__.'/TickerRoutes.php');

        // Load views from `Modules/Ticket/Views`
        $this-&gt;loadViewsFrom(__DIR__.'/Views', 'ticket');

        // Load the policies from `Modules/Ticket/TicketPolicy.php`
        $gate-&gt;policy(Ticket::class, TicketPolicy::class);

        // Load the configurations from `Modules/Ticket/TicketConfig.php`
        $this-&gt;mergeConfigFrom(
            __DIR__.'/TicketConfig.php', 'ticket';
        );
    }

    /**
     * Register any application services.
     *
     * @return void
     */
    public function register() {}
}
</code></pre>

<p>We can then access the configurations as :</p>

<pre><code class="php">$ccEmail = config('ticket.ticket_cc_email');
</code></pre>

<p>Now you can see entire module is bundled to a single folder. Easy to manage. There is a downside of registrations inside service provider class which in general you do not worry about. However, this is structurally more intuitive and re-usable.</p>

<p>If you would like your module to have more extensive and detailed structure, you can simply use this ready composer plugin : <a href="https://nwidart.com/laravel-modules/v4/introduction">nwidart/laravel-modules</a></p>

<p>Note : The structure and coding style are my personal opinions. There can be multiple ways to accomplish the same result. I feel just knowing the possibility that it can be done, opens new doors of imaginations based on personal comfort.</p>

            </div>
            <p>.....</p>
            <a href="https://techsemicolon.github.io/blog/2019/01/06/laravel-module-pattern/">Read full article</a>
                            <p class="tags">
                Tags:
                                <a href="https://techsemicolon.github.io/blog/tags/laravel">laravel</a>,                                 <a href="https://techsemicolon.github.io/blog/tags/php">php</a>,                                 <a href="https://techsemicolon.github.io/blog/tags/module">module</a>,                                 <a href="https://techsemicolon.github.io/blog/tags/bundle">bundle</a>                                </p>
                    </article>
    
            <article class="home-article">
            <header>
                <h2><a href="https://techsemicolon.github.io/blog/2019/01/04/laravel-restricting-unfiltered-queries/">Laravel restricting unfiltered queries</a></h2>
            </header>
            <div class="home-article-body">
                <p>Laravel eloquent is a very powerful ORM. I came across a situation for a project of mine long time ago. There was a table <code>api_logs</code> which basically logged all API requests and responses. Evidently the table grew exponentially. One of the developers created an analytics module in which he forgot to add a where clause. It queried millions of rows at a time on production. It was a silly mistake but server was overwhelmed and you can imagine the rest of story (I can tell you it is not that good).</p>

<p>I imagined if there was a way to just throw an error if any function queries all rows from a table like <code>api_logs</code>. Two advantages :</p>

<ul>
<li>Error will be thrown during the development cycle where it's like an eye opener for the developer to make sure he adds filters.</li>
<li>If the develolper pushed the code to live by mistake, someone requesting the page will get the error page. I will be still having advantage with x% of customers getting an error rather than 100% of customer not using website when memory is exhausted. (If that query was in the header or footer on every page then basically it's over haha!)</li>
</ul>

<h4 id="implementation-%3A">Implementation :</h4>

<p>Short and simple, nothing fancy. We will just intercept an eloquent model for every query and check if it has a where clause. The best place for that is <code>boot</code> method of the model. I wish laravel has <code>retreiving</code> observer just like <code>created</code>, <code>updated</code> etc, which intercepts the query before it hits the database connection. (I am guessing as observers basically observes the state of a model instance, the state prior to <code>retreiving</code> is ideally an inception step of preparing collection of models/model and not yet a prime state to observe. And hence no such observer yet available.)</p>

<p>We can however use <code>\DB::listen()</code> listener as follows :</p>

<pre><code class="php">&lt;?php

namespace App\Model;

use Illuminate\Database\Eloquent\Model;

class ApiLog extends Model
{
    /**
     * The table associated with the model.
     *
     * @var string
     */
    protected $table = 'api_logs';


    /**
     * The "booting" method of the model.
     *
     * @return void
     */
    public static function boot(){

        parent::boot();

        \DB::listen(function($query) {
            //
        }); 
    }
}
</code></pre>

<p>Note that for Laravel version <code>5.1</code> and lower, the parameters of listen callback are <code>$sql, $bindings, $time</code> instead of just <code>$query</code>;</p>

<p>Now we have an listener, we need to get the query and check if it is selecting all rows. We will do it by regex on the raw sql.</p>

<pre><code class="php">&lt;?php

    \DB::listen(function($query) {

        $table = (new self)-&gt;table;
        $pattern = "/from(\s)*?`?$table`?(\s)*$/m";

        if(preg_match($pattern, $query-&gt;sql)){
            throw new \Exception("Error : Running unfiltered queries on `$table` table is not allowed!");
        }
    }); 
}
</code></pre>

<p>Above preg match will catch all queries which do not have any clauses after the table syntax. Those can be select, update or delete queries.</p>

<p>Let's make this little more manageable by creating a trait and then using it in model. Create <code>RestrictsUnfilteredQueries.php</code> :</p>

<pre><code class="php">&lt;?php 

namespace App\Model;

trait RestrictsUnfilteredQueries
{
    /**
     * Restrict unfiltered queries
     * 
     * @return void
     * @throws \Exception
     */
    public static function restrictUnfilteredQueries()
    {
        \DB::listen(function($query) {

            $table = (new self)-&gt;table;
            $pattern = "/from(\s)*?`?$table`?(\s)*$/m";

            if(preg_match($pattern, $query-&gt;sql)){
                throw new \Exception("Error : Running unfiltered queries on `$table` table is not allowed!");
            }
        }); 
    }
}
</code></pre>

<p>Using in the model's boot method :</p>

<pre><code class="php">&lt;?php

namespace App\Model;

use Illuminate\Database\Eloquent\Model;
use App\Model\RestrictsUnfilteredQueries;

class ApiLog extends Model
{
    use RestrictsUnfilteredQueries;

    /**
     * The table associated with the model.
     *
     * @var string
     */
    protected $table = 'api_logs';


    /**
     * The "booting" method of the model.
     *
     * @return void
     */
    public static function boot(){

        parent::boot();

        self::restrictUnfilteredQueries(); 
    }
}
</code></pre>

<p>And done! Now your server RAM will thank you forever for this ;)</p>

<p>Note that this will not work when you query using DB facade like <code>DB::select()</code> or <code>DB::table()-&gt;get()</code>.</p>

<p>You may alternatively cater this as well by having <code>DB::listen()</code> inside a service provider's boot method. It will listen to all sort of queries. However, it might be too much to listen all queries.</p>

<p>There might be better way of implementing the same, I did it this way considering the urgency of situation. It is still there in project since then and working perfectly.</p>

            </div>
            <p>.....</p>
            <a href="https://techsemicolon.github.io/blog/2019/01/04/laravel-restricting-unfiltered-queries/">Read full article</a>
                            <p class="tags">
                Tags:
                                <a href="https://techsemicolon.github.io/blog/tags/laravel">laravel</a>,                                 <a href="https://techsemicolon.github.io/blog/tags/php">php</a>,                                 <a href="https://techsemicolon.github.io/blog/tags/security">security</a>,                                 <a href="https://techsemicolon.github.io/blog/tags/slowloading">slowloading</a>                                </p>
                    </article>
    
            <article class="home-article">
            <header>
                <h2><a href="https://techsemicolon.github.io/blog/2018/12/25/mysql-tips-for-local-shell-client/">MySQL tips for shell client</a></h2>
            </header>
            <div class="home-article-body">
                <p>How many of you use terminal when operating mysql instead of a GUI client like sequel pro or mysql workbench? There is nothing bad in using either of it as it depends on your choice of comfort.</p>

<p>I like to use terminal for it. Here are few tips which you might find helpful. These are not relelated to how you use mysql database in general, these are specific to the option files and mysql terminal client.</p>

<p>Before diving into it, just make sure you know where your mysql option file my.cnf is place. Server may have multiple my.cnf files. How mysql prioritizes them can be seen by typing :</p>

<pre><code class="bash">mysql --help | grep my.cnf
</code></pre>

<p><img src="/images/posts/mysql-tips-local-client/1.png" alt="Mysql cnf preference" title="" height="150px" /></p>

<p>This will give you a fair idea of how mysql is prioritizing these option files. I would suggest to have the option file .my.cnf for each user inside their home directory, which has specific options not revealing anything secretive for all mysql users. Again when I say each user, it is NOT mysql's user but the user you are logged into the shell terminal.</p>

<ol>
<li>Having a nice prompt is always great :</li>
</ol>

<p>When you login to mysql client, you will see basic promt like below, nothing fancy. However, wouldn't it be great to know what user you have logged in as and which database you are currently in? You can add following in .my.cnf :</p>

<pre><code class="bash">[mysql]

prompt=(\U):[\d]$\_
</code></pre>

<p><img src="/images/posts/mysql-tips-local-client/2.png" alt="Mysql shell prompt" /></p>

<p>This will give you a handy promt to always keep an eye.</p>

<ol start="2">
<li>Setting up default database &amp; credentials :</li>
</ol>

<p>It is not good to always write mysql -u user -p database.. when you can have that set to defaults you use everytime. You can add following in .my.cnf :</p>

<pre><code class="bash">[client]

user=mysqluser
password=mysqlpassword

[mysql]

prompt=(\U):[\d]$\_
database=databasename
</code></pre>

<p>Now you can just type mysql and you are good to go</p>

<ol start="3">
<li>Colorized output :</li>
</ol>

<p>Usual output of mysql shell client is in white which becomes confusing when you have multiple columns, text of the row proceeds to next row. I feel this colour-mysql-console is very handy :</p>

<p>Url : https://github.com/nitso/colour-mysql-console</p>

<p>Once you follow the steps for installtion, you will see following :</p>

<p><img src="/images/posts/mysql-tips-local-client/4.png" alt="Mysql colorized output" title="" height="150px" /></p>

<p>There are few options which you can use not in option file but directly while starting mysql shell client. These can be used as and when needed.</p>

<ol start="4">
<li>Saving the query result in file :</li>
</ol>

<p>Sometimes you might need to query something and then study those results later or maybe share it with a colleage etc. You can use the <code>tee</code> option :</p>

<pre><code class="bash">mysql --tee="/filepath/output.txt"
</code></pre>

<p>MySQL client will acknowledge this by saying : Logging to file '/filepath/output.txt'. Now each query's result will be stored in this file which is very handy.</p>

<p>You can use <code>notee</code> command if you want to disable a particular query result to be pushed into the output file.</p>

<ol start="5">
<li>Saving the result in HTML table format :</li>
</ol>

<p>This can be one of the cases but if you in case need to show a query result somewhere in pure table format, you can just use the <code>html</code> option :</p>

<pre><code class="bash">mysql --html
</code></pre>

<p><img src="/images/posts/mysql-tips-local-client/5.png" alt="Mysql HTML table result" /></p>

<p>Now you will see each query gives result in table, which you can easily put into your HTML page. Now this scenario may never likely come, but when it comes this will be a very quick option for you.</p>

<p>I use these on every local setup and it helps me very much in daily development activities. Hope you find it helpful.</p>

            </div>
            <p>.....</p>
            <a href="https://techsemicolon.github.io/blog/2018/12/25/mysql-tips-for-local-shell-client/">Read full article</a>
                            <p class="tags">
                Tags:
                                <a href="https://techsemicolon.github.io/blog/tags/mysql">mysql</a>,                                 <a href="https://techsemicolon.github.io/blog/tags/shell">shell</a>,                                 <a href="https://techsemicolon.github.io/blog/tags/client">client</a>,                                 <a href="https://techsemicolon.github.io/blog/tags/sql">sql</a>                                </p>
                    </article>
        <nav>
        <a href="https://techsemicolon.github.io/page/2">Newer Posts</a><br />
        <br />
    </nav>
                </div>
            </div>
        </main>
        <footer class="container">
            <span>Tech.Semicolon | &copy; 2019 </span>
        </footer>

        <script src="https://techsemicolon.github.io/components/jquery/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
        <script src="https://techsemicolon.github.io/components/bootstrap/js/bootstrap.min.js"></script>
                
                <script src="https://techsemicolon.github.io/components/highlightjs/highlight.pack.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>

                    </body>
</html>
